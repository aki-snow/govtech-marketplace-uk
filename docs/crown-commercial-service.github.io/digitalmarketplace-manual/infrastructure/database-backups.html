

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Database backups &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Domains" href="domains.html" />
    <link rel="prev" title="Code backups" href="code-backups.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/nix.html">Nix Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/moving-data.html">Moving data between environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-resources.html">AWS Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-backups.html">Code backups</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Database backups</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-our-database-backups-are-created">How our database backups are created</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-our-backup-script-does">What our backup script does</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-s3-buckets">The S3 buckets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signed-s3-url-s">Signed S3 URL’s</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gpg">GPG</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restoring-from-a-backup">Restoring from a backup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="emails.html">Email integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="jenkins.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rotate-keys.html">Rotating API keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Database backups</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/infrastructure/database-backups.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="database-backups">
<span id="id1"></span><h1><a class="toc-backref" href="#id3">Database backups</a><a class="headerlink" href="#database-backups" title="Permalink to this headline">¶</a></h1>
<p>We produce our own backups for the purpose of populating our development and local environments with up to date, sanitised data based on production data using the <a class="reference external" href="https://ci.marketplace.team/job/clean-and-apply-db-dump-s3/search/?q=clean-and-apply-db-dump">clean-and-apply-db-dump</a> Jenkins jobs.</p>
<p>For <a class="reference internal" href="#restoring-from-a-backup">Restoring from a backup</a> in a disaster scenario we use PaaS backups which offer a managed service and more fine grained point in time recovery options.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#database-backups" id="id3">Database backups</a></p>
<ul>
<li><p><a class="reference internal" href="#how-our-database-backups-are-created" id="id4">How our database backups are created</a></p></li>
<li><p><a class="reference internal" href="#what-our-backup-script-does" id="id5">What our backup script does</a></p></li>
<li><p><a class="reference internal" href="#the-s3-buckets" id="id6">The S3 buckets</a></p></li>
<li><p><a class="reference internal" href="#signed-s3-url-s" id="id7">Signed S3 URL’s</a></p></li>
<li><p><a class="reference internal" href="#gpg" id="id8">GPG</a></p></li>
<li><p><a class="reference internal" href="#restoring-from-a-backup" id="id9">Restoring from a backup</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="how-our-database-backups-are-created">
<h2><a class="toc-backref" href="#id4">How our database backups are created</a><a class="headerlink" href="#how-our-database-backups-are-created" title="Permalink to this headline">¶</a></h2>
<p>Backups are generated by a Jenkins job at 4am every morning. A dump is taken from the production database, which is then
zipped, encrypted and uploaded to a replicated S3 bucket, <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-database-backups</span></code> for storage. This is
done in the following steps:</p>
<ul class="simple">
<li><p>Jenkins creates a unique file name for the dump in the format <code class="docutils literal notranslate"><span class="pre">&lt;stage&gt;-yyyyMMddHHmm.sql.gz.gpg</span></code></p></li>
<li><p>Jenkins deploys a worker app, <code class="docutils literal notranslate"><span class="pre">db-backup</span></code> to the PaaS, using the <code class="docutils literal notranslate"><span class="pre">deploy-db-backup-app</span></code> Makefile command in the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws">digitalmarketplace-aws</a> repo. This app has the scripts required to create and upload the dump baked into its Docker
image (see <a class="reference external" href="https://hub.docker.com/r/digitalmarketplace/db-backup/">Digital Marketplace Docker Hub</a>).</p></li>
<li><p>The following environment variables are required by the app manifest:
- <code class="docutils literal notranslate"><span class="pre">DUMP_FILE_NAME</span></code> - the unique filename generated by Jenkins (passed as an argument to <code class="docutils literal notranslate"><span class="pre">deploy-db-backup-app</span></code>)
- <code class="docutils literal notranslate"><span class="pre">S3_POST_URL_DATA</span></code> - A signed url and extra data for POSTing the dump to S3. Explained below.
- <code class="docutils literal notranslate"><span class="pre">RECIPIENT</span></code> - Used for encryption with GPG, it signifies which public key to use to encrypt.</p></li>
<li><p>An additional variable <code class="docutils literal notranslate"><span class="pre">PUBKEY</span></code> (the public key used for encryption) is set after the app has spun up.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">db-backup</span></code> app then starts a task container which executes the <code class="docutils literal notranslate"><span class="pre">create-db-dump.sh</span></code>. This container has its
own disk and memory quotas, needed to handle the large file size.</p></li>
</ul>
</div>
<div class="section" id="what-our-backup-script-does">
<h2><a class="toc-backref" href="#id5">What our backup script does</a><a class="headerlink" href="#what-our-backup-script-does" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">create-db-dump.sh</span></code> script first imports <code class="docutils literal notranslate"><span class="pre">PUBKEY</span></code> into GPG2. It then connects to the database instance in the PaaS and
uses <code class="docutils literal notranslate"><span class="pre">pg_dump</span></code> to create a plaintext dump with no owner and no access control list. The dump is streamed to gzip and then
straight to GPG2 for encryption before being written to disk.</p>
<p>Next, a python script, <code class="docutils literal notranslate"><span class="pre">upload-dump-to-s3.py</span></code>, is executed for uploading the dump to S3. It uses <code class="docutils literal notranslate"><span class="pre">S3_POST_URL_DATA</span></code> (the
signed S3 url generated earlier) and will return an error if upload fails.</p>
<p>Next, Jenkins checks that the new encrypted dump in S3 can be decrypted. This is to ensure that the private key used to
decrypt the dumps is the correct counterpart of the public key used to encrypt. If the private key was rotated and the public
key wasn’t for some reason, we wouldn’t know about it until too late without this check. Jenkins uses a script called
<code class="docutils literal notranslate"><span class="pre">check-db-dump-is-decryptable.sh</span></code>.</p>
<p>The decrypt script downloads the new dump from S3. It then decrypts and imports the private GPG key from the credentials
repo and imports it. GPG then executes a <code class="docutils literal notranslate"><span class="pre">--list-packets</span></code> command on the dump. We don’t actually care about the packets,
but the command needs the correct private key to operate successfully. It means we can test decryption without actually
having to decrypt. Finally it deletes the secret key as well as the downloaded dump.</p>
<p>Finally, Jenkins alerts slack with either a success or failure message and deletes the <code class="docutils literal notranslate"><span class="pre">db-backup</span></code> app from the PaaS.</p>
</div>
<div class="section" id="the-s3-buckets">
<span id="id2"></span><h2><a class="toc-backref" href="#id6">The S3 buckets</a><a class="headerlink" href="#the-s3-buckets" title="Permalink to this headline">¶</a></h2>
<p>The bucket where zipped and encrypted dumps are stored in the first instance is called
<code class="docutils literal notranslate"><span class="pre">digitalmarketplace-database-backups</span></code> and is in the Digital Marketplace Backups AWS account.</p>
<p>This bucket has <a class="reference external" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/crr.html">cross region replication</a> enabled and will replicate all new objects to another bucket called
<code class="docutils literal notranslate"><span class="pre">digitalmarketplace-cross-region-database-backups</span></code> in the <code class="docutils literal notranslate"><span class="pre">eu-west-2</span> <span class="pre">(london)</span></code> region.</p>
<p>The buckets are accessible to 1 group and the Jenkins role.
The group is called ‘backups’ and contains the users currently in the <code class="docutils literal notranslate"><span class="pre">production_infrastructure</span></code> group.
This means that users on 2nd line support as well as permanent admins will be able to GET the backup files.
The Jenkins role only has permissions to PUT or GET on the bucket to prevent deletion of dumps.</p>
<p>The buckets sit in the <a class="reference external" href="/aws-accounts.html">digitalmarketplace-backups</a> account which can only be accessed using a password reset.</p>
<p>The backups in <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-database-backups</span></code> and <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-cross-region-database-backups</span></code> are
retained for 180 and 7 days respectively.</p>
</div>
<div class="section" id="signed-s3-url-s">
<h2><a class="toc-backref" href="#id7">Signed S3 URL’s</a><a class="headerlink" href="#signed-s3-url-s" title="Permalink to this headline">¶</a></h2>
<p>The ‘<cite>S3_POST_URL_DATA</cite>’ is generated by a script in the AWS repo called <code class="docutils literal notranslate"><span class="pre">generate-s3-post-url-data.py</span></code>. It needs to be
executed by an AWS entity with the correct rights to upload to the S3 Jenkins bucket. In our case this is the Jenkins role
assumed by the Jenkins server. The signed URL can then be used by an entity with no permissions on the bucket.</p>
</div>
<div class="section" id="gpg">
<h2><a class="toc-backref" href="#id8">GPG</a><a class="headerlink" href="#gpg" title="Permalink to this headline">¶</a></h2>
<p>The dumps are being encrypted with GPG2. The public and private keys being used are kept in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials</a>
repo. The private key is encrypted with SOPS in the usual way. The public key is unencrypted. The private key has a passphrase
which is required to use it. This is also in the credentials repo and is also encrypted with SOPS.</p>
<p>The keys use RSA 4096.</p>
</div>
<div class="section" id="restoring-from-a-backup">
<span id="database-restore"></span><h2><a class="toc-backref" href="#id9">Restoring from a backup</a><a class="headerlink" href="#restoring-from-a-backup" title="Permalink to this headline">¶</a></h2>
<p>There is no automatic process to restore the production database from one of the dumps. If we’re in the situation where it
needs to happen, it’s probably quite a serious situation and should probably be done manually. The steps will be similar
to below:</p>
<blockquote>
<div><ul>
<li><p>Alert the team on the <code class="docutils literal notranslate"><span class="pre">#dm-2ndline</span></code> Slack channel, and grab the deploy gorilla.</p></li>
<li><p>Disable writes to the database, either by putting the site into
<a class="reference internal" href="maintenance-mode.html#maintenance-mode"><span class="std std-ref">Maintenance mode</span></a> (preferred option) or stopping
the API app in PaaS (only as a last resort). Consider disabling
<a class="reference external" href="https://ci.marketplace.team/view/Functional,%20visual,%20and%20smoke%20tests/">smoke/smoulder tests</a>.</p></li>
<li><p>Ensure that you’re logged in to Cloud Foundry and are in the production
space (if that’s where you’re restoring to):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cf</span> <span class="n">target</span> <span class="o">-</span><span class="n">s</span> <span class="n">production</span>
</pre></div>
</div>
</li>
<li><p>Follow the <a class="reference external" href="https://docs.cloud.service.gov.uk/deploying_services/postgresql/#postgresql-service-backup">restore steps in the PaaS manual</a> to
create a new PostgreSQL service from a snapshot or point in time (depending
on need).  Give the new service a descriptive name like <code class="docutils literal notranslate"><span class="pre">restored-db</span></code>.</p></li>
<li><p>The restore will take at least 15 minutes to run.
If you need a cup of tea, now is the time.</p></li>
<li><p>Update the api app to use the new service by changing the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/vars/production.yml">production app
manifest variables</a>. Note: you will need to copy the entire <code class="docutils literal notranslate"><span class="pre">services</span></code> block from <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/vars/common.yml">common.yml</a> to <code class="docutils literal notranslate"><span class="pre">api</span></code> to stop other service bindings being removed.
Once this change is merged, re-release using the Jenkins job <a class="reference external" href="https://ci.marketplace.team/job/rerelease-all-apps/">rerelease-all-apps</a>.</p></li>
<li><p>Test that the data has restored correctly
(<a class="reference external" href="https://dm-api-production.cloudapps.digital/_status">https://dm-api-production.cloudapps.digital/_status</a> should respond even during
maintenance mode).</p></li>
<li><p>Let stakeholders know that the restore has been completed.</p></li>
<li><p>Ensure the team has a plan for reconciling any lost data, and how this will be communicated to users.</p></li>
<li><p>Rename the existing <code class="docutils literal notranslate"><span class="pre">digitalmarketplace_api_db</span></code> service to something like
<code class="docutils literal notranslate"><span class="pre">digitalmarketplace_api_db_old</span></code> (or just delete it altogether), and
rename the <code class="docutils literal notranslate"><span class="pre">restored-db</span></code> service to <code class="docutils literal notranslate"><span class="pre">digitalmarketplace_api_db</span></code>.</p></li>
<li><p>Revert the change to the production app manifest variables, and rerelease
all apps as above.</p></li>
<li><p>Toggle maintenance mode to ‘recovery’ to restore access to the API apps only.</p></li>
<li><p>Re-sync the Elasticsearch indices for services and briefs, using the Jenkins catchup jobs:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-briefs-index-production/">update-briefs-index-production</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-services-index-production/">update-services-index-production</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Toggle maintenance mode to ‘live’ to restore access to the Frontend apps.</p></li>
<li><p>Re-enable <a class="reference external" href="https://ci.marketplace.team/view/Functional,%20visual,%20and%20smoke%20tests/">smoke/smoulder tests</a> (if disabled earlier). And relax.</p></li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="domains.html" class="btn btn-neutral float-right" title="Domains" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="code-backups.html" class="btn btn-neutral float-left" title="Code backups" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>