

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Elasticsearch &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Jenkins" href="jenkins.html" />
    <link rel="prev" title="Email integration" href="emails.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/nix.html">Nix Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/moving-data.html">Moving data between environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-resources.html">AWS Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-backups.html">Code backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="database-backups.html">Database backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="emails.html">Email integration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Elasticsearch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#where-elasticsearch-data-is-used">Where Elasticsearch data is used</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-that-digital-marketplace-gets-from-elasticsearch">Data that Digital Marketplace gets from Elasticsearch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#briefs">Briefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#services">Services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#where-digital-marketplace-finds-that-data">Where Digital Marketplace finds that data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#postgres">Postgres</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Elasticsearch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#benefits-to-multi-index-single-type-model">Benefits to multi-index single-type model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#where-indexes-are-described">Where indexes are described</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-our-indexes-contain">What our indexes contain</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">Briefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-our-indexes-are-named">How our indexes are named</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-indexes-are-created">How indexes are created</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-indexes-are-populated">How indexes are populated</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#single-object-updates">Single object updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bulk-object-updates">Bulk object updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manually-updating">Manually updating</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#aliases">Aliases</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jobs">Jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-index">Create index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-index">Update index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-index-alias">Update index alias</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#catch-up-jobs">Catch-up jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#index-briefs">Index briefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#index-services">Index services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#manual-cleanup-jobs">Manual (cleanup) jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checking-the-elasticsearch-version">Checking the Elasticsearch version</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="jenkins.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rotate-keys.html">Rotating API keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Elasticsearch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/infrastructure/elasticsearch.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="elasticsearch">
<span id="id1"></span><h1><a class="toc-backref" href="#id9">Elasticsearch</a><a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#elasticsearch" id="id9">Elasticsearch</a></p>
<ul>
<li><p><a class="reference internal" href="#where-elasticsearch-data-is-used" id="id10">Where Elasticsearch data is used</a></p></li>
<li><p><a class="reference internal" href="#data-that-digital-marketplace-gets-from-elasticsearch" id="id11">Data that Digital Marketplace gets from Elasticsearch</a></p>
<ul>
<li><p><a class="reference internal" href="#briefs" id="id12">Briefs</a></p></li>
<li><p><a class="reference internal" href="#services" id="id13">Services</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#where-digital-marketplace-finds-that-data" id="id14">Where Digital Marketplace finds that data</a></p>
<ul>
<li><p><a class="reference internal" href="#postgres" id="id15">Postgres</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id16">Elasticsearch</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#benefits-to-multi-index-single-type-model" id="id17">Benefits to multi-index single-type model</a></p></li>
<li><p><a class="reference internal" href="#where-indexes-are-described" id="id18">Where indexes are described</a></p></li>
<li><p><a class="reference internal" href="#what-our-indexes-contain" id="id19">What our indexes contain</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id20">Briefs</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id21">Services</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-our-indexes-are-named" id="id22">How our indexes are named</a></p></li>
<li><p><a class="reference internal" href="#how-indexes-are-created" id="id23">How indexes are created</a></p></li>
<li><p><a class="reference internal" href="#how-indexes-are-populated" id="id24">How indexes are populated</a></p>
<ul>
<li><p><a class="reference internal" href="#single-object-updates" id="id25">Single object updates</a></p></li>
<li><p><a class="reference internal" href="#bulk-object-updates" id="id26">Bulk object updates</a></p></li>
<li><p><a class="reference internal" href="#manually-updating" id="id27">Manually updating</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#aliases" id="id28">Aliases</a></p></li>
<li><p><a class="reference internal" href="#jobs" id="id29">Jobs</a></p>
<ul>
<li><p><a class="reference internal" href="#create-index" id="id30">Create index</a></p></li>
<li><p><a class="reference internal" href="#update-index" id="id31">Update index</a></p></li>
<li><p><a class="reference internal" href="#update-index-alias" id="id32">Update index alias</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#catch-up-jobs" id="id33">Catch-up jobs</a></p>
<ul>
<li><p><a class="reference internal" href="#index-briefs" id="id34">Index briefs</a></p></li>
<li><p><a class="reference internal" href="#index-services" id="id35">Index services</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#manual-cleanup-jobs" id="id36">Manual (cleanup) jobs</a></p></li>
<li><p><a class="reference internal" href="#checking-the-elasticsearch-version" id="id37">Checking the Elasticsearch version</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="where-elasticsearch-data-is-used">
<h2><a class="toc-backref" href="#id10">Where Elasticsearch data is used</a><a class="headerlink" href="#where-elasticsearch-data-is-used" title="Permalink to this headline">¶</a></h2>
<p>Elasticsearch data is used in:</p>
<ul class="simple">
<li><p>Digital Outcomes and Specialists brief search</p>
<ul>
<li><p><a class="reference external" href="https://www.digitalmarketplace.service.gov.uk/digital-outcomes-and-specialists/opportunities">https://www.digitalmarketplace.service.gov.uk/digital-outcomes-and-specialists/opportunities</a></p></li>
<li><p>This is a list of <cite>all</cite> Digital Outcomes and Specialists briefs from all iterations of the framework</p></li>
</ul>
</li>
<li><p>G-Cloud services search</p>
<ul>
<li><p><a class="reference external" href="https://www.digitalmarketplace.service.gov.uk/g-cloud/search">https://www.digitalmarketplace.service.gov.uk/g-cloud/search</a></p></li>
<li><p>This is a list of services on the current G-Cloud framework iteration</p></li>
</ul>
</li>
</ul>
<p>The data on these pages is retrieved from Elasticsearch via the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a>.</p>
</div>
<div class="section" id="data-that-digital-marketplace-gets-from-elasticsearch">
<h2><a class="toc-backref" href="#id11">Data that Digital Marketplace gets from Elasticsearch</a><a class="headerlink" href="#data-that-digital-marketplace-gets-from-elasticsearch" title="Permalink to this headline">¶</a></h2>
<p>Digital Marketplace uses Elasticsearch to store data that needs to be searchable, filterable, retrieved quickly, and displayed in bulk.
Elasticsearch is <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_document_oriented.html#_document_oriented">document oriented</a> data store which means that every entry is stored and indexed as a JSON object called a document.</p>
<p>Digital Marketplace stores 2 types of documents, examples below…</p>
<div class="section" id="briefs">
<h3><a class="toc-backref" href="#id12">Briefs</a><a class="headerlink" href="#briefs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;briefs-digital-outcomes-and-specialists&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;briefs&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;4987&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
  <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;dmtext_applicationsClosedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-06-14T23:59:59.000000Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_clarificationQuestionsClosedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-06-07T23:59:59.000000Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_essentialRequirements&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Boil kettle&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Taste tea&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Wash mug&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Dry mug&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmtext_id&quot;</span><span class="p">:</span> <span class="mi">4987</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_location&quot;</span><span class="p">:</span> <span class="s2">&quot;London&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_location&quot;</span><span class="p">:</span> <span class="s2">&quot;London&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_lot&quot;</span><span class="p">:</span> <span class="s2">&quot;digital-specialists&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_lot&quot;</span><span class="p">:</span> <span class="s2">&quot;digital-specialists&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmagg_lot&quot;</span><span class="p">:</span> <span class="s2">&quot;digital-specialists&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_niceToHaveRequirements&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Talk snobbishly about water quality&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Sip quietly&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Provide biscuits&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmtext_organisation&quot;</span><span class="p">:</span> <span class="s2">&quot;NAO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sortonly_publishedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-05-31T10:40:48.086433Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_publishedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-05-31T10:40:48.086433Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_specialistRole&quot;</span><span class="p">:</span> <span class="s2">&quot;developer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_specialistRole&quot;</span><span class="p">:</span> <span class="s2">&quot;developer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_status&quot;</span><span class="p">:</span> <span class="s2">&quot;withdrawn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_status&quot;</span><span class="p">:</span> <span class="s2">&quot;withdrawn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_summary&quot;</span><span class="p">:</span> <span class="s2">&quot;Drink lots of tea. Brew kettle.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Tea drinker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_withdrawnAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-05-31T10:40:48.176191Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sortonly_idHash&quot;</span><span class="p">:</span> <span class="s2">&quot;23ed5d9b3c1e3abdd487d4a20bb02c1d88d91373d06cc362bf4278800ea7b55a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sortonly_statusOrder&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="mi">2</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="services">
<h3><a class="toc-backref" href="#id13">Services</a><a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;g-cloud-9-2018-03-12&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;services&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;467823511339503&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
  <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;dmfilter_educationPricing&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_emailOrTicketingSupport&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_frameworkName&quot;</span><span class="p">:</span> <span class="s2">&quot;G-Cloud 9&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_governmentSecurityClearances&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;dv&quot;</span><span class="p">,</span>
      <span class="s2">&quot;sc&quot;</span><span class="p">,</span>
      <span class="s2">&quot;bpss&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmtext_id&quot;</span><span class="p">:</span> <span class="s2">&quot;467823511339503&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_lot&quot;</span><span class="p">:</span> <span class="s2">&quot;cloud-support&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmagg_lot&quot;</span><span class="p">:</span> <span class="s2">&quot;cloud-support&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_lot&quot;</span><span class="p">:</span> <span class="s2">&quot;cloud-support&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_lotName&quot;</span><span class="p">:</span> <span class="s2">&quot;Cloud support&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_phoneSupport&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_resellingType&quot;</span><span class="p">:</span> <span class="s2">&quot;not_reseller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_serviceBenefits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Reduces risk by drawing on experienced and skilled resources&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ensures service management consequences are defined and understood&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Client side focus ensures truly impartial advice&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Ensure totality of services meet security requirements&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Demonstrate compliance with Digital by Default standards and GSDM&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Compatible with Actica’s other services for a total support package&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Compatible with Agile or Waterfall delivery approaches&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Sectors: defence, education, fire, health, justice, local authority, police, transport&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Understand and manage service transition risks&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Flexible resourcing to accommodate peaks and troughs in workload&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmtext_serviceDescription&quot;</span><span class="p">:</span> <span class="s2">&quot;Provides support during the procurement and delivery of business change programmes whether used in conjunction with SaaS, PaaS, IaaS, in-house service provision or outsourced service provision. Actica can provide a team to act as the Technical Design Authority (TDA), or experienced architects to support and strengthen an organisation&#39;s existing TDA.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_serviceFeatures&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Assessment of architecture, technical and schedule risks and issues&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Identification and management of risk treatment plans&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Technical Delivery Assurance of supplier&#39;s deliverables and plans&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Compliance with architectural principles assessed&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Compliance with artefacts assessed (Enterprise, Information, Technical and Applications)&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Compliance with contract documents, requirements and dependencies assessed&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Commissioning support including tender assessment&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Developing high level designs and solution designs&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Assessing key technical and architecture options and designs&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Essential support for successful disaggregation of supply chain&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmtext_serviceName&quot;</span><span class="p">:</span> <span class="s2">&quot;Technical Design Authority and Delivery Assurance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_staffSecurityClearanceChecks&quot;</span><span class="p">:</span> <span class="s2">&quot;staff_screening_not_bs7858_2012&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmtext_supplierName&quot;</span><span class="p">:</span> <span class="s2">&quot;Actica Consulting&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_webChatSupport&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sortonly_serviceIdHash&quot;</span><span class="p">:</span> <span class="s2">&quot;84486e218fbfe137001d371a842c73a8fb98c21be92b711609b1c48c680f5879&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmfilter_serviceCategories&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Planning&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Setup and migration&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Quality assurance and performance testing&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmagg_serviceCategories&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Planning&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Setup and migration&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Quality assurance and performance testing&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;dmtext_serviceCategories&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Planning&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Setup and migration&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Quality assurance and performance testing&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Digital Marketplace has a separate api (the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a>) to retrieve data from Elasticsearch, in a similar way to
how the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-api">api</a>  fetches data from the Postgres database with SQL queries.</p>
<p>Requests made by the frontend apps to the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a> are converted to the HTTP request format expected by Elasticsearch.
The <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a> then converts the Elasticsearch response into a format the frontend apps can use.</p>
<img alt="../_images/api-architecture.png" src="../_images/api-architecture.png" />
</div>
</div>
<div class="section" id="where-digital-marketplace-finds-that-data">
<h2><a class="toc-backref" href="#id14">Where Digital Marketplace finds that data</a><a class="headerlink" href="#where-digital-marketplace-finds-that-data" title="Permalink to this headline">¶</a></h2>
<p>Furthering the above <a class="reference external" href="https://www.elastic.co/blog/what-is-an-elasticsearch-index">comparison to Postgres</a>…</p>
<ul class="simple">
<li><p>In Postgres we have a database instance (one), tables (many) and rows (many).</p></li>
<li><p>In Elasticsearch there are indices (many), types (one) and documents (many).</p></li>
</ul>
<p>However, unlike a Postgres database, which may have many tables, an Elasticsearch index may only contain one document type.</p>
<p>This is demonstrated below in the diagrams of the internal structure of our data services…</p>
<div class="section" id="postgres">
<h3><a class="toc-backref" href="#id15">Postgres</a><a class="headerlink" href="#postgres" title="Permalink to this headline">¶</a></h3>
<img alt="../_images/dm-psql.png" src="../_images/dm-psql.png" />
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id16">Elasticsearch</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<img alt="../_images/dm-es.png" src="../_images/dm-es.png" />
<p>As we can see many indexes can exist at the same time.
Usually these are slightly different versions of the same data, denoted by a datestamp.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can check what indexes exist on what stage at the below links…</p>
<ul class="simple">
<li><p><a class="reference external" href="https://search-api.preview.marketplace.team/_status">https://search-api.preview.marketplace.team/_status</a></p></li>
<li><p><a class="reference external" href="https://search-api.staging.marketplace.team/_status">https://search-api.staging.marketplace.team/_status</a></p></li>
<li><p><a class="reference external" href="https://search-api.digitalmarketplace.service.gov.uk/_status">https://search-api.digitalmarketplace.service.gov.uk/_status</a></p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="benefits-to-multi-index-single-type-model">
<h2><a class="toc-backref" href="#id17">Benefits to multi-index single-type model</a><a class="headerlink" href="#benefits-to-multi-index-single-type-model" title="Permalink to this headline">¶</a></h2>
<p>Keeping our Elasticsearch ‘types’ in separate indices has a number of benefits.</p>
<ol class="arabic simple">
<li><p>As of Elasticsearch 6 multiple types in one index is not supported.</p></li>
<li><p>It allows us to control index level settings on an an object type basis like:</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>results per window</p></li>
<li><p>shards for index</p></li>
</ul>
</div></blockquote>
<p>This gives us tighter control over performance if we begin to experience higher load on just one document-type index.</p>
<p>For example: if there were more interest in G-Cloud 10 closer to the opening date of G-Cloud 11 we could boost the
number of shards for the g-cloud index and not the digital-outcomes-and-specialists one.</p>
<ol class="arabic simple" start="3">
<li><p>It allows us to create, manage and switch indexes based on the object type we’re indexing.</p></li>
</ol>
</div>
<div class="section" id="where-indexes-are-described">
<h2><a class="toc-backref" href="#id18">Where indexes are described</a><a class="headerlink" href="#where-indexes-are-described" title="Permalink to this headline">¶</a></h2>
<p>Mapping files that describe the indexes we can create are stored in <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api/tree/master/mappings">digitalmarketplace-search-api/mappings</a>.</p>
<p>These files are generated using the <code class="docutils literal notranslate"><span class="pre">generate-search-config.py</span></code> script in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-frameworks">digitalmarketplace-frameworks repo</a>.
This generates search mapping files from <code class="docutils literal notranslate"><span class="pre">search_mappings/&lt;object_type&gt;.json</span></code> template files and the
<code class="docutils literal notranslate"><span class="pre">manifests/&lt;object_type&gt;_search_filters.yml</span></code> filter file.</p>
<p>The mapping files describe both the index itself and the data. They are used to create and query the index as well as transforming responses.</p>
<p>For more information on how the mapping files work see the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-frameworks/blob/master/README.md#search-mappings">digitalmarketplace-frameworks README ‘Search Mappings’ section</a>.</p>
</div>
<div class="section" id="what-our-indexes-contain">
<h2><a class="toc-backref" href="#id19">What our indexes contain</a><a class="headerlink" href="#what-our-indexes-contain" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id20">Briefs</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The briefs index should contain the briefs from all iterations of the Digital Outcomes and Specialists framework. This
is because we want all briefs to be searchable in the list.</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id21">Services</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>The services index is named per framework iteration and contains the services only relevant to that iteration of the framework.</p>
</div>
</div>
<div class="section" id="how-our-indexes-are-named">
<h2><a class="toc-backref" href="#id22">How our indexes are named</a><a class="headerlink" href="#how-our-indexes-are-named" title="Permalink to this headline">¶</a></h2>
<p>We give the index a name based on the mapping file that was used to create it, suffixed by the date it was created.
However this is in no way enforced.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">briefs</span><span class="o">-</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span>
<span class="n">g</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span>
</pre></div>
</div>
</div>
<div class="section" id="how-indexes-are-created">
<h2><a class="toc-backref" href="#id23">How indexes are created</a><a class="headerlink" href="#how-indexes-are-created" title="Permalink to this headline">¶</a></h2>
<p>Indexes are created by passing a description <cite>mapping</cite> file as <code class="docutils literal notranslate"><span class="pre">--create-with-mapping</span></code> and index name as <code class="docutils literal notranslate"><span class="pre">--index</span></code>
argument to the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-scripts/blob/master/dmscripts/index_to_search_service.py">digitalmarketplace-scripts/scripts/index-to-search-service.py</a> script.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more information see the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-scripts/blob/master/scripts/index-to-search-service.py">index-to-search-service.py docstring</a></p>
</div>
<p>The index is created on the stage specified by the <code class="docutils literal notranslate"><span class="pre">&lt;stage&gt;</span></code> argument.
It is then populated with the objects specified by the <code class="docutils literal notranslate"><span class="pre">&lt;doc_type&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">--frameworks</span></code> arguments.</p>
<p>For instance the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="o">/</span><span class="n">index</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">py</span> <span class="n">briefs</span> <span class="n">preview</span> \
    <span class="o">--</span><span class="n">index</span><span class="o">=</span><span class="n">dos2</span><span class="o">-</span><span class="n">briefs</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> \
    <span class="o">--</span><span class="n">frameworks</span><span class="o">=</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="p">,</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="o">-</span><span class="mi">3</span> \
    <span class="o">--</span><span class="n">create</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">mapping</span><span class="o">=</span><span class="n">briefs</span><span class="o">-</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="o">-</span><span class="mi">2</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Creates a new index</p>
<ul>
<li><p>called <code class="docutils literal notranslate"><span class="pre">dos2-briefs-2019-03-18</span></code></p></li>
<li><p>on <code class="docutils literal notranslate"><span class="pre">preview</span></code></p></li>
<li><p>using the <code class="docutils literal notranslate"><span class="pre">briefs-digital-outcomes-and-specialists-2.json</span></code> mapping file from <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api/tree/master/mappings">digitalmarketplace-search-api/mappings</a>.</p></li>
</ul>
</li>
<li><p>It then populates that index</p>
<ul>
<li><p>with <code class="docutils literal notranslate"><span class="pre">briefs</span></code></p></li>
<li><p>on the <code class="docutils literal notranslate"><span class="pre">digital-outcomes-and-specialists</span></code>, <code class="docutils literal notranslate"><span class="pre">digital-outcomes-and-specialists-2</span></code> and <code class="docutils literal notranslate"><span class="pre">digital-outcomes-and-specialists-3</span></code> frameworks.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="how-indexes-are-populated">
<h2><a class="toc-backref" href="#id24">How indexes are populated</a><a class="headerlink" href="#how-indexes-are-populated" title="Permalink to this headline">¶</a></h2>
<p>Elasticsearch indexes are populated from data in the Postgres database. We copy one or more records from the database
as documents in to the index.</p>
<div class="section" id="single-object-updates">
<h3><a class="toc-backref" href="#id25">Single object updates</a><a class="headerlink" href="#single-object-updates" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>For briefs: indexing happens when the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-api/blob/master/app/main/views/briefs.py#L240">status is changed</a> or when a <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-api/blob/master/app/main/views/briefs.py#L354">brief is awarded</a>. Operations on draft
briefs do not trigger a reindex because they aren’t shown in the list of briefs we retrieve from Elasticsearch.</p></li>
<li><p>For services: <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-api/blob/master/app/main/views/drafts.py#L425">creation</a>, <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-api/blob/master/app/main/views/services.py#L159">update</a> or an <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-api/blob/master/app/main/views/services.py#L342">update of status</a> will trigger a reindex of the service.</p></li>
</ul>
</div>
<div class="section" id="bulk-object-updates">
<h3><a class="toc-backref" href="#id26">Bulk object updates</a><a class="headerlink" href="#bulk-object-updates" title="Permalink to this headline">¶</a></h3>
<p>When we create a new index we populate it with <cite>all</cite> relevant objects (eg all DOS briefs, or all the G-Cloud 11 services).</p>
<p>There are also catch up jobs (<a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-services-index-production/">index-services</a> and <a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-briefs-index-production/">index-briefs</a>) that run every night to ensure that objects in
the index have the same information as objects in the database.</p>
</div>
<div class="section" id="manually-updating">
<h3><a class="toc-backref" href="#id27">Manually updating</a><a class="headerlink" href="#manually-updating" title="Permalink to this headline">¶</a></h3>
<p>To manually refresh the objects in an index and make sure what’s in the index matches what’s in the database you can
use the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-scripts/blob/master/dmscripts/index_to_search_service.py">digitalmarketplace-scripts/scripts/index-to-search-service.py</a> script again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="o">/</span><span class="n">index</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">py</span> <span class="n">services</span> <span class="n">preview</span> <span class="o">--</span><span class="n">index</span><span class="o">=</span><span class="n">g</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">20</span> <span class="o">--</span><span class="n">frameworks</span><span class="o">=</span><span class="n">g</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="mi">11</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Updates the existing index</p>
<ul>
<li><p>called (<cite>or aliased to</cite>) <code class="docutils literal notranslate"><span class="pre">g-cloud-11-2019-07-20</span></code></p></li>
<li><p>with <code class="docutils literal notranslate"><span class="pre">services</span></code></p></li>
<li><p>on the <code class="docutils literal notranslate"><span class="pre">g-cloud-11</span></code> framework</p></li>
</ul>
</li>
</ul>
<p>You can also use the relevant <a class="reference internal" href="#update-index">Update index</a> jobs on <a class="reference external" href="https://ci.marketplace.team">Jenkins</a> as detailed in the <a class="reference internal" href="#jobs">Jobs</a> section below.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There is no script or job for updating a single object. It is usually quicker and easier to rebuild the whole index.</p>
</div>
</div>
</div>
<div class="section" id="aliases">
<h2><a class="toc-backref" href="#id28">Aliases</a><a class="headerlink" href="#aliases" title="Permalink to this headline">¶</a></h2>
<p>An Elasticsearch index can be referenced by its full name, but it can also have a shortcut name called an alias. When
making requests to the Elasticsearch service the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">digitalmarketplace-search-api</a> uses an alias. An alias is comparable
to a url for an app.</p>
<p>The benefit to this setup is that we can create new indexes in the Elasticsearch service and only repoint the alias
when we’re ready. This is how we create and switch over to new indexes without downtime.</p>
<p>The connection is always made to the alias name but the index behind the alias can be switched.</p>
<ul class="simple">
<li><p>Create a new index</p></li>
<li><p>Repoint the alias</p></li>
</ul>
<img alt="../_images/es-aliases.png" src="../_images/es-aliases.png" />
<p>The script and jobs to update an index can also operate on an alias.</p>
<p>For example if we consider the above diagram and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="o">/</span><span class="n">index</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">py</span> <span class="n">services</span> <span class="n">preview</span> <span class="o">--</span><span class="n">index</span><span class="o">=</span><span class="n">g</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="mi">11</span> <span class="o">--</span><span class="n">frameworks</span><span class="o">=</span><span class="n">g</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="mi">11</span>
</pre></div>
</div>
<ul class="simple">
<li><p>This will update the index</p>
<ul>
<li><p>aliased to <code class="docutils literal notranslate"><span class="pre">g-cloud-11</span></code></p></li>
<li><p>called <code class="docutils literal notranslate"><span class="pre">g-cloud-11-2019-07-28</span></code></p></li>
<li><p>with <code class="docutils literal notranslate"><span class="pre">services</span></code></p></li>
<li><p>on the <code class="docutils literal notranslate"><span class="pre">g-cloud-11</span></code> framework</p></li>
</ul>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Index aliases are more important than index names.</p>
<p>The alias name we expect for Digital Outcomes and Specialists briefs is hard coded to <code class="docutils literal notranslate"><span class="pre">briefs-digital-outcomes-and-specialists</span></code>,
which covers all iterations of Digital Outcomes and Specialists. This is set in the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-buyer-frontend/blob/master/app/main/views/marketplace.py#L210">Buyer FE list_opportunities view</a>.</p>
<p>The alias name we expect for G-Cloud iterations is the slug of the latest live framework iteration (currently <code class="docutils literal notranslate"><span class="pre">g-cloud-11</span></code>),
determined via a database query <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-buyer-frontend/blob/master/app/main/views/g_cloud.py#L233">here</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also check what aliases we’re using at these links:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://search-api.preview.marketplace.team/_status">https://search-api.preview.marketplace.team/_status</a></p></li>
<li><p><a class="reference external" href="https://search-api.staging.marketplace.team/_status">https://search-api.staging.marketplace.team/_status</a></p></li>
<li><p><a class="reference external" href="https://search-api.digitalmarketplace.service.gov.uk/_status">https://search-api.digitalmarketplace.service.gov.uk/_status</a></p></li>
</ul>
</div>
</div>
<div class="section" id="jobs">
<h2><a class="toc-backref" href="#id29">Jobs</a><a class="headerlink" href="#jobs" title="Permalink to this headline">¶</a></h2>
<p>We have jobs on Jenkins to manage the creation and updating of indexes.
When adding a new framework these jobs are not run automatically and must be triggered by a developer.</p>
<div class="section" id="create-index">
<span id="id5"></span><h3><a class="toc-backref" href="#id30">Create index</a><a class="headerlink" href="#create-index" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/create-index-preview/">create-index-preview</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/create-index-staging/">create-index-staging</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/create-index-production/">create-index-production</a></p></li>
</ul>
</div></blockquote>
<p>See the base template for these Jenkins jobs: <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/job_definitions/create_index.yml">create_index.yml</a>.</p>
<p>Creates a new index on the relevant stage populated from the db with the specified objects from the specified frameworks.
Use to create a new index from a mapping file and specified objects.
Particularly useful when a preview or staging index has its database rebuilt, or if you have removed or replaced objects
in the database and these changes need to be reflected in the index.
Jenkins runs this job after rebuilding the preview DB from a snapshot (each weekend).</p>
</div>
<div class="section" id="update-index">
<h3><a class="toc-backref" href="#id31">Update index</a><a class="headerlink" href="#update-index" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-index-preview/">update-index-preview</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-index-staging/">update-index-staging</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-index-production/">update-index-production</a></p></li>
</ul>
</div></blockquote>
<p>See the base template for these Jenkins jobs: <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/job_definitions/update_index.yml">update_index.yml</a>.</p>
<p>Instead of creating, target an existing index (by name or alias), and update it from the db with the specified objects
from the specified frameworks.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This job will not remove objects from the index that no longer exist in the database. If there are objects in the
index that are not in the database then fully rebuild the index.</p>
</div>
</div>
<div class="section" id="update-index-alias">
<span id="id6"></span><h3><a class="toc-backref" href="#id32">Update index alias</a><a class="headerlink" href="#update-index-alias" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-index-alias-preview/">update-index-alias-preview</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-index-alias-staging/">update-index-alias-staging</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-index-alias-production/">update-index-alias-production</a></p></li>
</ul>
</div></blockquote>
<p>See the base template for these Jenkins jobs: <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/job_definitions/update_index_alias.yml">update_index_alias.yml</a>.</p>
<p>Given an alias name and a target index, create or replace the alias for the given index.</p>
<p>This will change which index sits behind an alias.</p>
</div>
</div>
<div class="section" id="catch-up-jobs">
<h2><a class="toc-backref" href="#id33">Catch-up jobs</a><a class="headerlink" href="#catch-up-jobs" title="Permalink to this headline">¶</a></h2>
<p>These jobs use the above <a class="reference internal" href="#update-index">Update index</a> job but with hard coded parameters. They are timed to run overnight as a
failsafe, re-syncing any Elasticsearch records that have got out of sync for whatever reason.</p>
<div class="section" id="index-briefs">
<h3><a class="toc-backref" href="#id34">Index briefs</a><a class="headerlink" href="#index-briefs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-briefs-index-preview/">update-briefs-index-preview</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-briefs-index-staging/">update-briefs-index-staging</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-briefs-index-production/">update-briefs-index-production</a></p></li>
</ul>
</div></blockquote>
<p>See the base template for these Jenkins jobs: <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/job_definitions/index_briefs.yml">update_index_alias.yml</a>.</p>
<p>This shortcut job runs the <a class="reference internal" href="#update-index">Update index</a> job (at 3 am) targeted at the index currently identified by the
<code class="docutils literal notranslate"><span class="pre">briefs-digital-outcomes-and-specialists</span></code> alias and pushes all briefs in to that index.</p>
</div>
<div class="section" id="index-services">
<h3><a class="toc-backref" href="#id35">Index services</a><a class="headerlink" href="#index-services" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-services-index-preview/">update-services-index-preview</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-services-index-staging/">update-services-index-staging</a></p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/view/ES%20indexes/job/update-services-index-production/">update-services-index-production</a></p></li>
</ul>
</div></blockquote>
<p>See the base template for these Jenkins jobs: <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/job_definitions/index_services.yml">update_index_alias.yml</a>.</p>
<p>This shortcut job runs the <a class="reference internal" href="#update-index">Update index</a> job (at 2 am) targeted at the index currently identified by the
<code class="docutils literal notranslate"><span class="pre">g-cloud-11</span></code> alias and pushes G-Cloud 11 services in to that index.</p>
</div>
</div>
<div class="section" id="manual-cleanup-jobs">
<h2><a class="toc-backref" href="#id36">Manual (cleanup) jobs</a><a class="headerlink" href="#manual-cleanup-jobs" title="Permalink to this headline">¶</a></h2>
<p>If everything is working as expected then you shouldn’t need to use these commands; indexes are created, replaced
and destroyed automatically.</p>
<p>Sometimes however it will be necessary to clean everything up.
Orphaned indexes may have been left lying around after manually testing a new index or framework iteration.
These are worth getting rid of, particularly on production where their names can be viewed on the <a class="reference external" href="https://search-api.digitalmarketplace.service.gov.uk/_status">search-api status page</a>.</p>
<p>To do this we ssh in to a <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a> instance and issue a <code class="docutils literal notranslate"><span class="pre">curl</span></code> command to the Elasticsearch service:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">login</span></code> in to the space you want to operate in</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">env</span> <span class="pre">search-api</span></code> and find the <code class="docutils literal notranslate"><span class="pre">System-Provided.VCAP_SERVICES.elasticsearch.uri</span></code> value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">ssh</span> <span class="pre">search-api</span></code> (this is required because only <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a> instances are bound to the Elasticsearch backing service)</p></li>
<li><p>Supply the relevant curl command</p></li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-X</span> <span class="pre">DELETE</span> <span class="pre">&quot;&lt;FULL_URI_VALUE&gt;/&lt;INDEX_NAME&gt;&quot;</span></code> to <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-delete-index.html#indices-delete-index">delete an index using curl</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-X</span> <span class="pre">DELETE</span> <span class="pre">&quot;&lt;FULL_URI_VALUE&gt;/&lt;INDEX_NAME&gt;/_alias/&lt;ALIAS_NAME&gt;&quot;</span></code> <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-aliases.html#deleting">delete an alias using curl</a></p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="checking-the-elasticsearch-version">
<h2><a class="toc-backref" href="#id37">Checking the Elasticsearch version</a><a class="headerlink" href="#checking-the-elasticsearch-version" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If doing this on production write an <cite>&#64;here</cite> message on the <cite>#dm-development</cite> Slack channel before you SSH into the app.</p>
</div>
<p>Use the following steps to check the version of Elasticsearch running in PaaS:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">login</span></code> in to the space you want to operate in</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">env</span> <span class="pre">search-api</span></code> and find the <code class="docutils literal notranslate"><span class="pre">System-Provided.VCAP_SERVICES.elasticsearch.uri</span></code> value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">ssh</span> <span class="pre">search-api</span></code> (this is required because only <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-search-api">search-api</a> instances are bound to the Elasticsearch backing service)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-X</span> <span class="pre">GET</span> <span class="pre">&lt;FULL_URI_VALUE&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exit</span></code> to close the SSH tunnel.</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="jenkins.html" class="btn btn-neutral float-right" title="Jenkins" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="emails.html" class="btn btn-neutral float-left" title="Email integration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>