

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Nix Environments &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data model" href="data-model.html" />
    <link rel="prev" title="Digital Marketplace Runner (‘dmrunner’)" href="digitalmarketplace-runner.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Nix Environments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#who-s-nick">Who’s nick?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#default-nix">default.nix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-pure-flag">The –pure flag</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#default-nix-files-in-digital-marketplace-repositories">default.nix files in Digital Marketplace repositories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#caveats">Caveats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#local-nix">local.nix</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#default-nix-in-the-functional-tests-repo">default.nix in the functional tests repo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="moving-data.html">Moving data between environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/aws-resources.html">AWS Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/code-backups.html">Code backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/database-backups.html">Database backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/emails.html">Email integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/jenkins.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rotate-keys.html">Rotating API keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Nix Environments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/developing-the-digital-marketplace/nix.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nix-environments">
<h1><a class="toc-backref" href="#id1">Nix Environments</a><a class="headerlink" href="#nix-environments" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nix-environments" id="id1">Nix Environments</a></p>
<ul>
<li><p><a class="reference internal" href="#who-s-nick" id="id2">Who’s nick?</a></p>
<ul>
<li><p><a class="reference internal" href="#default-nix" id="id3">default.nix</a></p></li>
<li><p><a class="reference internal" href="#the-pure-flag" id="id4">The –pure flag</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#default-nix-files-in-digital-marketplace-repositories" id="id5">default.nix files in Digital Marketplace repositories</a></p>
<ul>
<li><p><a class="reference internal" href="#caveats" id="id6">Caveats</a></p></li>
<li><p><a class="reference internal" href="#local-nix" id="id7">local.nix</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#default-nix-in-the-functional-tests-repo" id="id8">default.nix in the functional tests repo</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The Nix setup for the Digital Marketplace is no longer maintained. Parts may be broken or missing. This document is purely for historic information. See the <a class="reference internal" href="developer-setup.html#developer-setup"><span class="std std-ref">developer setup</span></a> instead.</p>
</div>
<p>This page documents a <strong>totally optional</strong> (yet rather convenient) means of automatically setting up reproducible
development environments for some Digital Marketplace components. For a user with Nix installed, spawning an ephemeral
development environment for a nix-ified project can be as simple as performing a:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ nix-shell --pure .
</pre></div>
</div>
<p>from the source directory.</p>
<div class="section" id="who-s-nick">
<h2><a class="toc-backref" href="#id2">Who’s nick?</a><a class="headerlink" href="#who-s-nick" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://nixos.org/nix">Nix</a> describes itself as a <a class="reference external" href="https://en.wikipedia.org/wiki/Functional_programming">functional</a>
package manager, though it’s possibly better thought of as a build tool, as Nix has a fairly broad definition of what
a “package” can be. A “package” can be anything from a single file to a meta-package of other “packages” or even a whole
runtime environment built from these dependency building blocks.</p>
<p>Packages’ build instructions are described in <code class="docutils literal notranslate"><span class="pre">.nix</span></code> files using Nix’s
<a class="reference external" href="http://nixos.org/nix/manual/#chap-writing-nix-expressions">own</a> (quite
<a class="reference external" href="https://en.wikipedia.org/wiki/Purely_functional_programming">pure</a>) functional programming language . Nix focuses on
attempting to build “pure” packages - that is, packages whose only external references are to files derived from other
“pure” packages. This allows Nix to provide supposedly totally reproducible environments given a set of instructions,
with applications that behave in a way totally independent of the underlying impure environment.</p>
<p>To do this, Nix forgoes the traditional unix filesystem heirarchy (<code class="docutils literal notranslate"><span class="pre">/usr/lib</span></code>, <code class="docutils literal notranslate"><span class="pre">/bin</span></code> and all your old friends) in
favour of installing <em>everything</em> in a hash-based-named directory under <code class="docutils literal notranslate"><span class="pre">/nix/store</span></code>. Items under the Nix store are
only bound together into a specific runtime environment as and when needed (either through some clever symlink tricks
or by very selectively and specifically including certain items in a particular environment’s environment variables
on demand). Breaking the system’s reliance on fixed filesystem paths enables Nix to have an arbitrary number of
different versions of components (that would normally cause conflicts) installed at the same time without problems.</p>
<p>If you’ve ever needed two versions of OpenSSL installed at the same time (each used by a different piece of software),
you’ll find there’s a problem because only one file can occupy <code class="docutils literal notranslate"><span class="pre">/usr/lib/libssl.so</span></code> at once. It’s <em>possible</em> to use
some tricks to build depending software against specific versions of libraries installed in specific locations, or
in <code class="docutils literal notranslate"><span class="pre">/usr/local/lib</span></code>, but doing so is build tool-specific and each project’s build system will vary in how reliably
this works, and we’re not even mentioning getting the build to use the correct match of libraries to headers. In Nix
this isn’t an issue because only the <em>specific</em> version of the library you asked for is included in the environment at
build time and the resultant software is made to reference this library in its <em>specific</em> location.</p>
<p>TL;DR is with Nix, there’s nothing stopping you running a number of different entire <em>distributions</em> at the same time
on top of the same kernel, even with entirely different <code class="docutils literal notranslate"><span class="pre">libc</span></code> versions. Note that from a technical perspective, this
is <em>not</em> the same thing as containerization or virtualization - there is no os-policed enforcement of environment
separation (either from a security or resource partitioning point of view) - it is simply that one application stack’s
dependencies are completely separable from another’s. Such enforcement <em>can</em> be added if so desired, but in
development environments that’s not the feature we’re generally looking for and more often than not gets in the way.</p>
<p>This makes it sound like a lot of compiling is involved, but because Nix is able to identify unique packages by hash
(the hash used is based on the full set of input parameters given to the package’s build environment, so it’s possible
to determine a package’s identifying hash <em>before</em> building it), Nix can fetch pre-compiled versions of popular packages
from its “binary cache” - a build farm run by the Nix project. Little building is usually required, but when it is it
is of course totally transparent to the Nix user.</p>
<p><code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> is the standard set of package definitions that Nix tends to use. It contains a similar selection of
software as would be found in a typical Linux distribution (or maybe Homebrew). It’s <em>actually</em> just a tree of <code class="docutils literal notranslate"><span class="pre">.nix</span></code>
files and is <a class="reference external" href="https://github.com/NixOS/nixpkgs">maintained in GitHub</a> similarly how to any other open source project
would be.</p>
<p>Nix officially runs on x86 Linux and MacOS (technically known as “darwin”) (and unofficially on a few others) and can
operate completely independently of any existing system package manager. The concept has been taken further with the
<a class="reference external" href="https://nixos.org/">NixOS</a> project - a Linux distribution built entirely on top of Nix, using it to produce an
entirely “stateless” system. That is, the only parts of the system that maintain state are the user data areas and
parts of <code class="docutils literal notranslate"><span class="pre">var</span></code>, using Nix to even build its configuration files and populate <cite>/etc</cite> with these when system
configuration is changed. I don’t advocate going this far <em>just</em> yet, at least not for development.</p>
<p><code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> <code class="docutils literal notranslate"><span class="pre">master</span></code> is a continually-rolling collection of software which gets a stable branch forked off
approximately every 6 months. At time of writing the most recent one is <code class="docutils literal notranslate"><span class="pre">19.03</span></code>. These stable branches are
synchronized with NixOS releases, so you may occasionally see the stable branch referred to as e.g. <code class="docutils literal notranslate"><span class="pre">nixos-19.03</span></code>.</p>
<p>Nix works on MacOS (“darwin”). That said, it doesn’t work <em>quite</em> as well as it does on Linux, for two reasons. Firstly
the proprietary nature of the underlying platform makes purity more difficult for some of the lower level system
libraries. Secondly there are just fewer users than on Linux, so packages get less attention and testing.</p>
<p>The <a class="reference external" href="http://nixos.org/nix/manual">Nix manual</a> provides further information on Nix and the
<a class="reference external" href="http://nixos.org/nixpkgs/manual/">nixpkgs manual</a> details various conventions used throughout <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> and
the many useful tools and shortcuts it provides for those writing expressions in the nix language.</p>
<div class="section" id="default-nix">
<h3><a class="toc-backref" href="#id3">default.nix</a><a class="headerlink" href="#default-nix" title="Permalink to this headline">¶</a></h3>
<p>One of the modes in which one can use Nix is through <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code>. Given a Nix expression (usually residing in a
<code class="docutils literal notranslate"><span class="pre">.nix</span></code> file), <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code> will ensure all the dependencies specified by the expression are present on the system
and then launch a shell in an ephemeral environment into which it has injected those dependencies.</p>
<p>If this sounds a bit like <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code>, it is - only it works for the whole system environment, not just python
dependencies. It has sometimes been described as a “whole-system virtualenv”. A major difference is that as soon as the
user ends the shell session the environment is as good as gone - it holds no state itself.</p>
<p>A useful way to maintain this environment description is with a <code class="docutils literal notranslate"><span class="pre">default.nix</span></code> file in a project’s root directory.
The relevance of the filename <code class="docutils literal notranslate"><span class="pre">default.nix</span></code> is simply that it’s the default filename <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code> will look for when
invoked in a directory and no other name is provided.</p>
</div>
<div class="section" id="the-pure-flag">
<h3><a class="toc-backref" href="#id4">The –pure flag</a><a class="headerlink" href="#the-pure-flag" title="Permalink to this headline">¶</a></h3>
<p>A neat trick that <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code> can do, through use of the <code class="docutils literal notranslate"><span class="pre">--pure</span></code> flag, is clean the provided environment of
<em>everything</em> but the nix-provided dependencies specified by the supplied nix expression. Including (and this is largely
the point) your system-provided tools and libraries. This is extremely useful to reduce the liklihood an operation
you’re performing isn’t inadvertantly referencing “impure” system components and therefore is as reproducible as
possible. This can be quite critical if the inner operation you’re performing is building software and you want to make
sure the result is only dependent on your nix-reproducible environment.</p>
</div>
</div>
<div class="section" id="default-nix-files-in-digital-marketplace-repositories">
<h2><a class="toc-backref" href="#id5">default.nix files in Digital Marketplace repositories</a><a class="headerlink" href="#default-nix-files-in-digital-marketplace-repositories" title="Permalink to this headline">¶</a></h2>
<p>Several Digital Marketplace repositories now include an experimental <code class="docutils literal notranslate"><span class="pre">default.nix</span></code> which, used with <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code>,
should be able to provide a full execution environment for development and testing.</p>
<p>The idea is that a user with Nix installed should be able to perform a:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ nix-shell --pure .
</pre></div>
</div>
<p>and obtain a fully working development environment (it may be necessary to blow away your <code class="docutils literal notranslate"><span class="pre">node_modules/</span></code> and
<code class="docutils literal notranslate"><span class="pre">bower_components/</span></code> directories before running <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">run_all</span></code> to get them re-fetched again as they will have been
constructed using a different node version).</p>
<p>The environment’s python version can be chosen by editing the definition of <code class="docutils literal notranslate"><span class="pre">pythonPackages</span></code> - probably by editing
the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pythonPackages</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">python36Packages</span><span class="p">;</span>
</pre></div>
</div>
<p>to reference e.g. <code class="docutils literal notranslate"><span class="pre">python27Packages</span></code>. The line might of course not look exactly like that in all <code class="docutils literal notranslate"><span class="pre">default.nix</span></code>
files. <code class="docutils literal notranslate"><span class="pre">default.nix</span></code> has been set up to use a separate virtualenv for each python version so it should be possible to
drop out &amp; back in to different python versions without any extra fuss.</p>
<div class="section" id="caveats">
<h3><a class="toc-backref" href="#id6">Caveats</a><a class="headerlink" href="#caveats" title="Permalink to this headline">¶</a></h3>
<p>You’ll notice that if you use the <code class="docutils literal notranslate"><span class="pre">--pure</span></code> flag with <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code>, it gives you a really very pure environment - it
won’t even put <code class="docutils literal notranslate"><span class="pre">vi</span></code> in your environment. In fact, nothing from your underlying system installation will be directly
available. This is great for reasons outlined in the section on <a class="reference internal" href="#the-pure-flag">The –pure flag</a>, but could indeed be quite annoying
for day to day use. There are numerous approaches that could be taken to make this easier. It’s up to you which one you
prefer. Some suggestions:</p>
<ul class="simple">
<li><p>Don’t use the <code class="docutils literal notranslate"><span class="pre">--pure</span></code> flag and live with the danger of mixed up libraries. This will allow you to continue using
your underlying installed tools.</p></li>
<li><p>Only use <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code> for execution of the actual project commands, either dropping out of <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code> whenever
you’re not using the project commands, or leaving another shell active in the same directory for performing those
commands. This is <em>probably</em> the approach I’ll take.</p></li>
<li><p>Add your tool of choice to the dependencies using a <code class="docutils literal notranslate"><span class="pre">local.nix</span></code>, causing Nix to provide this tool for you. See the
section on <a class="reference internal" href="#local-nix">local.nix</a>.</p></li>
</ul>
<p>Something to note is that this is not a <em>full</em> nixification - for the majority of the python dependencies, it just
creates a <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code> and calls <code class="docutils literal notranslate"><span class="pre">pip</span></code> at the last stage of its initialization. This means that the installed
python modules aren’t pure in the same way proper Nix packages are. The worst effect this should have is maybe
occasionally having to blow away your <code class="docutils literal notranslate"><span class="pre">venv*</span></code> dirs after you’ve updated your nix channels.</p>
<p>There’s also a possibility that <code class="docutils literal notranslate"><span class="pre">pip</span></code> will too aggressively cache compiled modules that it installs and not realize
that it’s being asked to build/install modules against a totally different set of headers &amp; libs as it was last time
it was invoked. I haven’t actually see this be a problem yet, so we’ll probably cross that bridge when we come to it.</p>
<p><strong>MacOS users</strong> will, for now, have to <strong>comment out</strong> the <code class="docutils literal notranslate"><span class="pre">watchdog</span></code> dependency in <code class="docutils literal notranslate"><span class="pre">requirements_for_test.txt</span></code> as
it appears to need some impure dependencies to access system libraries (?). But there are possibly a few workarounds for
this that can be discussed. The first that comes to mind is adding the <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> package for watchdog
(<code class="docutils literal notranslate"><span class="pre">pythonPackages.watchdog</span></code>, which, strangely enough, <em>does</em> work fine on MacOS even though I can’t <em>quite</em>
figure out exactly how its build environment differs) to your <code class="docutils literal notranslate"><span class="pre">local.nix</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">$PS1</span></code> (custom prompt) provided may not be to everyone’s taste. I tried to include a bunch of useful information
in it, including a <code class="docutils literal notranslate"><span class="pre">shortName</span></code> for each project which some may find objectionable (this is so that it’s clear if
you’ve absent-mindedly <code class="docutils literal notranslate"><span class="pre">cd</span></code>’d to a different project directory while remaining in a <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code>). As shown in the
example, this can also be personalized in <code class="docutils literal notranslate"><span class="pre">local.example.nix</span></code>, or over time we might agree on a better default one.</p>
<p>As much as this document talks about the “total reproducibility” of the environment, the truth is of course that
<code class="docutils literal notranslate"><span class="pre">default.nix</span></code> bases itself on whatever your systems current default <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> is set to track. This is embodied
in the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pkgs</span> <span class="o">=</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">nixpkgs</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre></div>
</div>
<p>If you stick to a stable branch, your results should remain mostly… stable… across <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> updates, but of
course different people with <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code> set to track different branches/releases <em>could</em> get different results.</p>
<p>It <em>would</em> be perfectly possible to replace this line with e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nixpkgs</span> <span class="o">=</span> <span class="p">(</span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">nixpkgs</span><span class="o">&gt;</span> <span class="p">{})</span><span class="o">.</span><span class="n">fetchFromGitHub</span> <span class="p">{</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="s2">&quot;NixOS&quot;</span><span class="p">;</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="s2">&quot;nixpkgs-channels&quot;</span><span class="p">;</span>
    <span class="n">rev</span> <span class="o">=</span> <span class="s2">&quot;0d4431cfe90b2242723ccb1ccc90714f2f68a609&quot;</span><span class="p">;</span>
    <span class="n">sha256</span> <span class="o">=</span> <span class="s2">&quot;0iil6dx91widz66avnbs4m8lhygmadhyma1m2kbq57iwj73yql3w&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>and achieve a much higher degree of reproducibility through something akin to “pinning” the environment to a specific
snapshot of <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code>. This is an approach that some people take, but it could well become annoying as we’d have to
continually be bumping this version to stay up to date with security releases and the like. I suggest we play this by
ear for now.</p>
</div>
<div class="section" id="local-nix">
<h3><a class="toc-backref" href="#id7">local.nix</a><a class="headerlink" href="#local-nix" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">default.nix</span></code> files have been designed to look aside at evaluation time for a file named <code class="docutils literal notranslate"><span class="pre">local.nix</span></code>. The
contents are expected to be a nix expression defining a function. If the file is present, this function will be called
applying first the args passed to the original default.nix and then <code class="docutils literal notranslate"><span class="pre">oldAttrs</span></code>, the attrset originally applied to
mkDerivation. If that explanation means nothing to you, read the section of the manual
<a class="reference external" href="http://nixos.org/nix/manual/#chap-writing-nix-expressions">describing the nix language</a>. Alternatively, each
repository with a <code class="docutils literal notranslate"><span class="pre">default.nix</span></code> should include a <code class="docutils literal notranslate"><span class="pre">local.example.nix</span></code> which should outline the basic idea and
can be copied and adapted to a users needs.</p>
<p><code class="docutils literal notranslate"><span class="pre">local.nix</span></code> should have been added to the <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code> so we shouldn’t end up committing our personal settings.</p>
</div>
</div>
<div class="section" id="default-nix-in-the-functional-tests-repo">
<h2><a class="toc-backref" href="#id8">default.nix in the functional tests repo</a><a class="headerlink" href="#default-nix-in-the-functional-tests-repo" title="Permalink to this headline">¶</a></h2>
<p>A slightly different approach has been taken in the <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-functional-tests</span></code> repository, mostly because
I am much less familiar with <code class="docutils literal notranslate"><span class="pre">bundler</span></code> than I am with <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code> and am less confident in hijacking some of its
functionality. Nix comes with a tool called <code class="docutils literal notranslate"><span class="pre">bundix</span></code> which is able to generate a <code class="docutils literal notranslate"><span class="pre">.nix</span></code> file from a <code class="docutils literal notranslate"><span class="pre">Gemfile</span></code> and
<code class="docutils literal notranslate"><span class="pre">Gemfile.lock</span></code>. This means that the gems get installed as actual nix packages, inheriting the purity benefits of
doing so (though notably not <em>all</em> of the benefits of using properly maintained packages from <code class="docutils literal notranslate"><span class="pre">nixpkgs</span></code>). The
<code class="docutils literal notranslate"><span class="pre">bundix</span></code> tool is included in this env to make it possible for people to regenerate <code class="docutils literal notranslate"><span class="pre">gemset.nix</span></code>.</p>
<p><strong>Disadvantages</strong> of this approach are that the <code class="docutils literal notranslate"><span class="pre">gemset.nix</span></code> file needs to be kept in sync with the <code class="docutils literal notranslate"><span class="pre">Gemfile.lock</span></code>
to remain useful and it’s not always obvious when things have slipped slightly out of sync. Also you’re no longer using
the same tool to install your language-level dependencies everywhere so it may not be obvious when subtle problems
creep in which don’t affect the Nix environment, but do affect a <code class="docutils literal notranslate"><span class="pre">bundler</span></code>-generated one.</p>
<p>If we really loved this approach, it <em>is</em> possible to do the same thing for python projects <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files
using a tool called <code class="docutils literal notranslate"><span class="pre">pypi2nix</span></code> (I’m not super-keen on it personally, but am open to exploring it). Note that at time
of writing it is being discussed whether to introduce a <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>-generation step into our toolchain so it
<em>could</em> end up being quite natural to autogenerate a <code class="docutils literal notranslate"><span class="pre">.nix</span></code> file at the same time.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="data-model.html" class="btn btn-neutral float-right" title="Data model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="digitalmarketplace-runner.html" class="btn btn-neutral float-left" title="Digital Marketplace Runner (‘dmrunner’)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>