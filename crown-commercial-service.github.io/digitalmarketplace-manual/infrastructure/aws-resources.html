

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>AWS Resources &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Code backups" href="code-backups.html" />
    <link rel="prev" title="AWS accounts and access" href="aws-accounts.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/nix.html">Nix Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/moving-data.html">Moving data between environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">AWS Resources</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#s3">S3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#documents-served-from-s3">Documents served from S3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#s3-buckets">S3 Buckets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cross-region-replication">Cross region replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mfa-delete">MFA Delete</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#iam">IAM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#actors-and-actions">Actors and Actions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#iam-identities">IAM Identities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#users">Users</a></li>
<li class="toctree-l4"><a class="reference internal" href="#groups">Groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#roles">Roles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#permissions">Permissions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#policies">Policies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-these-can-fit-together">How these can fit together</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-account-iam-management">Multi Account IAM Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="#digital-marketplace-users-iam">Digital Marketplace Users IAM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#further-reading">Further reading</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="code-backups.html">Code backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="database-backups.html">Database backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="emails.html">Email integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="jenkins.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rotate-keys.html">Rotating API keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>AWS Resources</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/infrastructure/aws-resources.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="aws-resources">
<span id="id1"></span><h1><a class="toc-backref" href="#id4">AWS Resources</a><a class="headerlink" href="#aws-resources" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#aws-resources" id="id4">AWS Resources</a></p>
<ul>
<li><p><a class="reference internal" href="#s3" id="id5">S3</a></p>
<ul>
<li><p><a class="reference internal" href="#documents-served-from-s3" id="id6">Documents served from S3</a></p></li>
<li><p><a class="reference internal" href="#s3-buckets" id="id7">S3 Buckets</a></p></li>
<li><p><a class="reference internal" href="#cross-region-replication" id="id8">Cross region replication</a></p></li>
<li><p><a class="reference internal" href="#mfa-delete" id="id9">MFA Delete</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#iam" id="id10">IAM</a></p>
<ul>
<li><p><a class="reference internal" href="#actors-and-actions" id="id11">Actors and Actions</a></p>
<ul>
<li><p><a class="reference internal" href="#iam-identities" id="id12">IAM Identities</a></p></li>
<li><p><a class="reference internal" href="#users" id="id13">Users</a></p></li>
<li><p><a class="reference internal" href="#groups" id="id14">Groups</a></p></li>
<li><p><a class="reference internal" href="#roles" id="id15">Roles</a></p></li>
<li><p><a class="reference internal" href="#permissions" id="id16">Permissions</a></p></li>
<li><p><a class="reference internal" href="#policies" id="id17">Policies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-these-can-fit-together" id="id18">How these can fit together</a></p></li>
<li><p><a class="reference internal" href="#multi-account-iam-management" id="id19">Multi Account IAM Management</a></p></li>
<li><p><a class="reference internal" href="#digital-marketplace-users-iam" id="id20">Digital Marketplace Users IAM</a></p></li>
<li><p><a class="reference internal" href="#further-reading" id="id21">Further reading</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>We use a number of AWS services to host parts of the Digital Marketplace. Most of them are managed by
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/tree/master/terraform">Terraform</a> modules in the digitalmarketplace-aws repo.</p>
<p>This include things like S3 buckets for document storage, CloudWatch <a class="reference internal" href="logging.html#logging"><span class="std std-ref">logs and metrics</span></a>, and Route 53 DNS records.</p>
<p>We host Jenkins using an EC2 instance in the main account.</p>
<p>Our AWS config is monitored by the GDS Cyber Security team’s <a class="reference internal" href="../managing-people-and-secret-things/accounts.html#cloud-security-watch"><span class="std std-ref">Cloud Security Watch tool</span></a>.</p>
<div class="section" id="s3">
<h2><a class="toc-backref" href="#id5">S3</a><a class="headerlink" href="#s3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="documents-served-from-s3">
<h3><a class="toc-backref" href="#id6">Documents served from S3</a><a class="headerlink" href="#documents-served-from-s3" title="Permalink to this headline">¶</a></h3>
<p>The use of the term ‘documents’ here refers to downloadable content such as agreement and signature pages for suppliers, pricing and description pages for services and reports for admins.
Commonly as PDFs or CSVs. See the <a class="reference internal" href="#s3-buckets">S3 Buckets</a> section for more.</p>
<p>These documents are served from S3, through the domain <code class="docutils literal notranslate"><span class="pre">assets.digitalmarketplace.service.gov.uk</span></code>.
These requests are proxied through the router app which maps the request to a public bucket and path URL defined in the
router app’s <code class="docutils literal notranslate"><span class="pre">templates/assets.j2</span></code> configuration file, which in turn depends on a set of variables of the form
<code class="docutils literal notranslate"><span class="pre">$*_s3_url</span></code>, defined in the <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-credentials</span></code> <code class="docutils literal notranslate"><span class="pre">vars</span></code> files.</p>
<p>The second element of the public path is used to decide which of the <code class="docutils literal notranslate"><span class="pre">$*_s3_url</span></code> to use as the base of the bucket url.
This base url is then joined with the <em>full, original public path</em> to build the final S3 url.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">assets</span><span class="o">.</span><span class="n">digitalmarketplace</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">uk</span><span class="o">/</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="n">communications</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">opportunity</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
<p>Maps to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">digitalmarketplace</span><span class="o">-</span><span class="n">documents</span><span class="o">-</span><span class="n">production</span><span class="o">-</span><span class="n">production</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">digital</span><span class="o">-</span><span class="n">outcomes</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">specialists</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="n">communications</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">opportunity</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
<p>Because the 2nd element of the url is <code class="docutils literal notranslate"><span class="pre">communications</span></code>, and the <code class="docutils literal notranslate"><span class="pre">communications_s3_url</span></code> value in <code class="docutils literal notranslate"><span class="pre">templates/assets.j2</span></code> is mapped to <code class="docutils literal notranslate"><span class="pre">https://digitalmarketplace-communications-production-production.s3.amazonaws.com</span></code>.</p>
<p>Some other, non-public files are served directly to the user using temporary “pre-signed” S3 urls.</p>
</div>
<div class="section" id="s3-buckets">
<h3><a class="toc-backref" href="#id7">S3 Buckets</a><a class="headerlink" href="#s3-buckets" title="Permalink to this headline">¶</a></h3>
<p>The app uses a number of S3 buckets. These include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">digitalmarketplace-documents-&lt;stage&gt;-&lt;environment&gt;</span></code>: documents linked to from live G-Cloud services, served from
the <code class="docutils literal notranslate"><span class="pre">assets</span></code> domain for the environment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">digitalmarketplace-communications-&lt;stage&gt;-&lt;environment&gt;</span></code>: documents relevant to particular framework application
processes - contracts, invitations to apply, MISO reporting templates, as well as files uploaded by framework owner admins
(clarification question responses, and general during-application communications) - at least some of these are public
and served from the <code class="docutils literal notranslate"><span class="pre">assets</span></code> domain.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">digitalmarketplace-submissions-&lt;stage&gt;-&lt;environment&gt;</span></code>: documents uploaded by suppliers as part of draft G-Cloud
services, private to the supplier who uploaded them (NOT public and NOT served from the <code class="docutils literal notranslate"><span class="pre">assets</span></code> domain)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">digitalmarketplace-agreements-&lt;stage&gt;-&lt;environment&gt;</span></code>: framework agreement documents generated by us for suppliers,
and those returned by suppliers once they’re signed (private to the suppliers, NOT public and NOT served from
<code class="docutils literal notranslate"><span class="pre">assets</span></code> domain)</p></li>
</ul>
<p>Where <code class="docutils literal notranslate"><span class="pre">&lt;stage&gt;</span></code> is either <code class="docutils literal notranslate"><span class="pre">preview</span></code> <code class="docutils literal notranslate"><span class="pre">staging</span></code> or <code class="docutils literal notranslate"><span class="pre">production</span></code>. While <code class="docutils literal notranslate"><span class="pre">&lt;environment&gt;</span></code> is hypothetically the
“sub-instance” of each stage, in practise, at time of writing at least, we only have one <em>environment</em> per stage and so
we basically just end up echoing the <code class="docutils literal notranslate"><span class="pre">&lt;stage&gt;</span></code>. Hence e.g. <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-communications-staging-staging</span></code>.</p>
<p>There is also:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">digitalmarketplace-dev-uploads</span></code>: bucket where all local development things end up (submissions, documents,
agreements and communications)</p></li>
</ul>
</div>
<div class="section" id="cross-region-replication">
<h3><a class="toc-backref" href="#id8">Cross region replication</a><a class="headerlink" href="#cross-region-replication" title="Permalink to this headline">¶</a></h3>
<p>We use cross region replication (<code class="docutils literal notranslate"><span class="pre">eu-west-1</span></code> to <code class="docutils literal notranslate"><span class="pre">eu-west-2</span></code>) to back up some of our buckets.
The <code class="docutils literal notranslate"><span class="pre">documents</span></code>, <code class="docutils literal notranslate"><span class="pre">communications</span></code>, <code class="docutils literal notranslate"><span class="pre">submissions</span></code> and <code class="docutils literal notranslate"><span class="pre">agreements</span></code> buckets in production and preview are all
backed up this way as are the database dumps in the <code class="docutils literal notranslate"><span class="pre">backups</span></code> bucket/ account.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="database-backups.html#the-s3-buckets"><span class="std std-ref">The S3 buckets</span></a> (database replication)</p>
</div>
<p>To initialise replication you first need to create the bucket in to which you will be replicating (the destination
bucket), then tell the source bucket to replicate all files to the new bucket.</p>
<p>The replication configuration is applied via the <code class="docutils literal notranslate"><span class="pre">aws_s3_bucket.replication_configuration</span></code> option in the terraform
files:</p>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/environments/preview/s3_replication_buckets.tf#L77">terraform/environments/preview/s3_replication_buckets.tf</a>
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/environments/preview/s3_buckets.tf#L130">terraform/environments/preview/s3_buckets.tf</a></p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://aws.amazon.com/blogs/aws/new-cross-region-replication-for-amazon-s3/">https://aws.amazon.com/blogs/aws/new-cross-region-replication-for-amazon-s3/</a></p>
</div>
</div>
<div class="section" id="mfa-delete">
<h3><a class="toc-backref" href="#id9">MFA Delete</a><a class="headerlink" href="#mfa-delete" title="Permalink to this headline">¶</a></h3>
<p>Most of our buckets have <a class="reference external" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/MultiFactorAuthenticationDelete.html">MFA delete</a> enabled. You need access to the relevant root AWS account to delete from one of those buckets.</p>
</div>
</div>
<div class="section" id="iam">
<span id="id3"></span><h2><a class="toc-backref" href="#id10">IAM</a><a class="headerlink" href="#iam" title="Permalink to this headline">¶</a></h2>
<p>Digital Marketplace accounts use the AWS IAM (Identity and Access Management) service to manage permissions relating to AWS infrastructure components.</p>
<p>Digital Marketplace uses a system of users/ groups, permissions/ policies and roles to share access to resources across accounts.</p>
<div class="section" id="actors-and-actions">
<h3><a class="toc-backref" href="#id11">Actors and Actions</a><a class="headerlink" href="#actors-and-actions" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the
<a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html">AWS Tutorial: Delegate Access Across AWS Accounts Using IAM Roles</a>
for a simplified example of how this can work.</p>
</div>
<div class="section" id="iam-identities">
<h4><a class="toc-backref" href="#id12">IAM Identities</a><a class="headerlink" href="#iam-identities" title="Permalink to this headline">¶</a></h4>
<p>Actions in AWS must be performed by an identity.
Identities can be attributed to different kinds of actors.
For example an EC2 instance, a Lambda, an AWS service (such as
<a class="reference external" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/setting-repl-config-perm-overview.html#setting-repl-config-same-acctowner">S3 replication</a>)
or <a class="reference internal" href="../developing-the-digital-marketplace/users.html#users"><span class="std std-ref">Users</span></a> are all IAM identities.</p>
</div>
<div class="section" id="users">
<h4><a class="toc-backref" href="#id13">Users</a><a class="headerlink" href="#users" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html</a></p>
<p>Users are a type of IAM identity that are used to represent actors that are not AWS infrastructure (i.e. people). Commonly they are used to log in to the console.</p>
</div>
<div class="section" id="groups">
<h4><a class="toc-backref" href="#id14">Groups</a><a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html</a></p>
<p>Groups are not IAM identities. They are a collection of (only) user type IAM identities. One user can belong to many groups, one group can contain many users.</p>
</div>
<div class="section" id="roles">
<h4><a class="toc-backref" href="#id15">Roles</a><a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html</a></p>
<p>Roles are another type of IAM identity. Other IAM identities can ‘assume’ a role and perform actions as that role. Think of it like logging in as a different user with different permissions.</p>
</div>
<div class="section" id="permissions">
<h4><a class="toc-backref" href="#id16">Permissions</a><a class="headerlink" href="#permissions" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html</a></p>
<p>Permissions describe actions in AWS.
For example if your user has the permission <code class="docutils literal notranslate"><span class="pre">s3:GetObject</span></code> on a bucket key <em>and</em> that bucket allows your user to s3:GetObject on its keys you can download an object from an S3 bucket.</p>
</div>
<div class="section" id="policies">
<h4><a class="toc-backref" href="#id17">Policies</a><a class="headerlink" href="#policies" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html</a></p>
<p>Polices are groups of permissions. They can be attached to IAM Identities or groups.</p>
</div>
</div>
<div class="section" id="how-these-can-fit-together">
<h3><a class="toc-backref" href="#id18">How these can fit together</a><a class="headerlink" href="#how-these-can-fit-together" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is an example and does not accurately reflect <em>our</em> setup.</p>
</div>
<p>A common pattern for setting up roles, groups and policies is:</p>
<ul class="simple">
<li><p>Users are added to groups</p></li>
<li><p>All the users of a given group are given permission to assume certain roles</p></li>
<li><p>The permission to actually do anything is attached to the role</p></li>
</ul>
<p>This is demonstrated below where unbroken lines represent granting permissions and dotted lines represent assuming a role:</p>
<img alt="../_images/example-roles-groups-policies.png" src="../_images/example-roles-groups-policies.png" />
<p>In this example we can see that:</p>
<p>Jenkins only gets one permission:</p>
<ul class="simple">
<li><p>Jenkins is given permission to assume the CI role</p></li>
<li><p>The CI role is given permission to ‘Update App Code’</p></li>
<li><p>When Jenkins assumes its CI role it can ‘Update App Code’</p></li>
</ul>
<p>Users in the ‘Account Admin’ group are given the highest level of access:</p>
<ul class="simple">
<li><p>They are given permission to assume both the ‘Account Admin’ role and the ‘Developers’ role</p></li>
<li><p>The Account Admin role gets 2 permissions</p></li>
<li><p>The Developers role gets 3 permissions</p></li>
<li><p>This means that by assuming the different roles the users in the Admins group can access all the permissions</p></li>
</ul>
</div>
<div class="section" id="multi-account-iam-management">
<h3><a class="toc-backref" href="#id19">Multi Account IAM Management</a><a class="headerlink" href="#multi-account-iam-management" title="Permalink to this headline">¶</a></h3>
<p>This pattern starts to make more sense in a multi account structure.</p>
<p>For simplicity we will define a single group of users in our primary account that should be able to update the CI
server and deploy code in our other accounts (PROD and DEV):</p>
<img alt="../_images/example-multi-account-roles.png" src="../_images/example-multi-account-roles.png" />
<p>In the above image we have 3 accounts.</p>
<ul class="simple">
<li><p>A primary account (AWS Account 1) where we manage permissions and have a CI  server performing our deployments</p></li>
<li><p>A PROD account where we run our production infrastructure</p></li>
<li><p>A DEV account where we run our development infrastructure</p></li>
</ul>
<p>The Developers group in the main account is given permission to assume 3 different roles.
One in each account.</p>
<p>Notice that the DEV and PROD accounts are identical. By using roles we have allowed our accounts to use the same structure.</p>
</div>
<div class="section" id="digital-marketplace-users-iam">
<h3><a class="toc-backref" href="#id20">Digital Marketplace Users IAM</a><a class="headerlink" href="#digital-marketplace-users-iam" title="Permalink to this headline">¶</a></h3>
<p>Digital Marketplace uses a system of users, groups, policies and roles to share access to resources across accounts
much like the simplified example above.</p>
<p>All of the permissions, roles and groups are defined using terraform. The lists of group membership are contained in the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials/terraform/accounts/main.json">credentials repo</a>.</p>
<p>The below image shows the roles that we grant to users that can log in:</p>
<img alt="../_images/aws-accounts.png" src="../_images/aws-accounts.png" />
<p>Each account has a root user indicated by a crown. As per
<a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html">AWS recommendation</a> we lock this user by
forgetting the password. The Cyber Security team monitor password reset requests on the root accounts, so let them
know in advance (e.g. via their Slack channel <code class="docutils literal notranslate"><span class="pre">#cyber-security-help</span></code>) if you need to do this.</p>
<p>The solid lines indicate an explicit grant of access to a role, dotted lines are a grant implied by a broad permissions policy.</p>
<p>It’s important to remember that to get access to a role in another account the group must be granted access by
both their account and the account that the role belongs to.</p>
</div>
<div class="section" id="further-reading">
<h3><a class="toc-backref" href="#id21">Further reading</a><a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h3>
<p>For more information on the accounts and roles Digital Marketplace employs see the section <a class="reference internal" href="aws-accounts.html#aws-accounts"><span class="std std-ref">AWS accounts and access</span></a>.</p>
<p>For an example of how to add a user to a given group see the <a class="reference internal" href="../managing-people-and-secret-things/accounts.html#managing-aws-accounts"><span class="std std-ref">AWS</span></a> section of the <a class="reference internal" href="../managing-people-and-secret-things/accounts.html#accounts"><span class="std std-ref">Adding and removing access for new starters / leavers</span></a> page.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="code-backups.html" class="btn btn-neutral float-right" title="Code backups" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="aws-accounts.html" class="btn btn-neutral float-left" title="AWS accounts and access" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>