

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Jenkins &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GitHub Actions" href="github-actions.html" />
    <link rel="prev" title="Elasticsearch" href="elasticsearch.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/nix.html">Nix Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/moving-data.html">Moving data between environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-resources.html">AWS Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-backups.html">Code backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="database-backups.html">Database backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="emails.html">Email integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Jenkins</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-we-use-jenkins-for">What we use Jenkins for</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-and-deploying-jobs-to-jenkins">Accessing and deploying jobs to Jenkins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jenkins-logging">Jenkins Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jenkins-infrastructure">Jenkins infrastructure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#shared-infrastructure">Shared Infrastructure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#elb-certificate">ELB certificate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#roles-and-policies">Roles and policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#access-log-s3-bucket">Access log S3 bucket</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ebs-snapshots">EBS snapshots</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#per-instance-infrastructure">Per-instance Infrastructure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ec2">EC2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#elb">ELB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dns-record-route-53">DNS record (Route 53)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#security-groups">Security Groups</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#installing-jenkins-itself">Installing Jenkins itself</a></li>
<li class="toctree-l3"><a class="reference internal" href="#destroying-jenkins">Destroying Jenkins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rebuilding-jenkins-from-scratch">Rebuilding Jenkins from scratch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-jenkins-uses-credentials">How Jenkins uses credentials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#jenkins-global-configuration">Jenkins global configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decrypting-dm-credentials">Decrypting dm-credentials</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#jenkins-chores">Jenkins chores</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rotate-keys.html">Rotating API keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Jenkins</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/infrastructure/jenkins.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="jenkins">
<span id="id1"></span><h1><a class="toc-backref" href="#id2">Jenkins</a><a class="headerlink" href="#jenkins" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#jenkins" id="id2">Jenkins</a></p>
<ul>
<li><p><a class="reference internal" href="#what-we-use-jenkins-for" id="id3">What we use Jenkins for</a></p></li>
<li><p><a class="reference internal" href="#accessing-and-deploying-jobs-to-jenkins" id="id4">Accessing and deploying jobs to Jenkins</a></p></li>
<li><p><a class="reference internal" href="#jenkins-logging" id="id5">Jenkins Logging</a></p></li>
<li><p><a class="reference internal" href="#jenkins-infrastructure" id="id6">Jenkins infrastructure</a></p>
<ul>
<li><p><a class="reference internal" href="#shared-infrastructure" id="id7">Shared Infrastructure</a></p>
<ul>
<li><p><a class="reference internal" href="#elb-certificate" id="id8">ELB certificate</a></p></li>
<li><p><a class="reference internal" href="#roles-and-policies" id="id9">Roles and policies</a></p></li>
<li><p><a class="reference internal" href="#access-log-s3-bucket" id="id10">Access log S3 bucket</a></p></li>
<li><p><a class="reference internal" href="#ebs-snapshots" id="id11">EBS snapshots</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#per-instance-infrastructure" id="id12">Per-instance Infrastructure</a></p>
<ul>
<li><p><a class="reference internal" href="#ec2" id="id13">EC2</a></p></li>
<li><p><a class="reference internal" href="#elb" id="id14">ELB</a></p></li>
<li><p><a class="reference internal" href="#dns-record-route-53" id="id15">DNS record (Route 53)</a></p></li>
<li><p><a class="reference internal" href="#security-groups" id="id16">Security Groups</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#installing-jenkins-itself" id="id17">Installing Jenkins itself</a></p></li>
<li><p><a class="reference internal" href="#destroying-jenkins" id="id18">Destroying Jenkins</a></p></li>
<li><p><a class="reference internal" href="#rebuilding-jenkins-from-scratch" id="id19">Rebuilding Jenkins from scratch</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-jenkins-uses-credentials" id="id20">How Jenkins uses credentials</a></p>
<ul>
<li><p><a class="reference internal" href="#jenkins-global-configuration" id="id21">Jenkins global configuration</a></p></li>
<li><p><a class="reference internal" href="#decrypting-dm-credentials" id="id22">Decrypting dm-credentials</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#jenkins-chores" id="id23">Jenkins chores</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="what-we-use-jenkins-for">
<h2><a class="toc-backref" href="#id3">What we use Jenkins for</a><a class="headerlink" href="#what-we-use-jenkins-for" title="Permalink to this headline">¶</a></h2>
<p>We use <a class="reference external" href="https://jenkins.io/">Jenkins</a> for:</p>
<ul class="simple">
<li><p>deploying applications through our release pipeline</p></li>
<li><p>running smoke tests and functional tests</p></li>
<li><p>running scheduled scripts (usually overnight)</p></li>
<li><p>tagging packaged libraries and Docker images, after a change has been merged</p></li>
</ul>
<p>Jenkins can be accessed at <a class="reference external" href="https://ci.marketplace.team">https://ci.marketplace.team</a>.</p>
<p>Our Jenkins jobs are defined in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins">digitalmarketplace-jenkins repo</a>, in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/job_definitions">job definitions directory</a>.</p>
</div>
<div class="section" id="accessing-and-deploying-jobs-to-jenkins">
<h2><a class="toc-backref" href="#id4">Accessing and deploying jobs to Jenkins</a><a class="headerlink" href="#accessing-and-deploying-jobs-to-jenkins" title="Permalink to this headline">¶</a></h2>
<p>Developers can have access to Jenkins once they are security cleared.</p>
<p>For HTTPS and SSH access to Jenkins you must be on GDS network or VPN; allowed IP addresses are defined in
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials/blob/master/terraform/common.json">digitalmarketplace-credentials/terraform/common.json</a>.
Authentication is done using your Github account; the list of allowed users is found in
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials/blob/master/jenkins-vars/jenkins.yaml">digitalmarketplace-credentials/jenkins-vars/jenkins.yaml</a>.</p>
<p>For SSH access to Jenkins, we use Github developer SSH keys. These keys are gathered by the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/playbooks/roles/jenkins/tasks/01_keys.yml">keys ansible task</a>, which
needs to be re-run to propagate any changes made to the set of trusted SSH keys. We also have a shared key called <code class="docutils literal notranslate"><span class="pre">ci</span></code>
in the <code class="docutils literal notranslate"><span class="pre">aws-keys</span></code> directory of the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials repo</a>, however you should generally not need
to use this.</p>
<p>See <a class="reference internal" href="../managing-people-and-secret-things/accounts.html#jenkins-accounts"><span class="std std-ref">Adding and removing access for new starters / leavers</span></a> for a step-by-step guide.</p>
<p>Instructions on how to <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/README.md#to-ssh-onto-the-jenkins-box">SSH into the Jenkins box</a> or <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/README.md#to-deploy">deploy new Jenkins jobs</a> can be found in the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/README.md">digitalmarketplace-jenkins repo README</a>.</p>
</div>
<div class="section" id="jenkins-logging">
<h2><a class="toc-backref" href="#id5">Jenkins Logging</a><a class="headerlink" href="#jenkins-logging" title="Permalink to this headline">¶</a></h2>
<p>For debugging and auditing purposes, we have configured Jenkins to log various events. You can log into the
<a class="reference external" href="https://eu-west-1.console.aws.amazon.com/cloudwatch/home?region=eu-west-1#logs">CloudWatch console</a> and look at the relevant log groups to see what’s been happening.</p>
<p>All of the below log events are streamed to AWS CloudWatch using the Amazon CloudWatch Logs Agent
(see <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/pull/173">PR #173</a> for details).</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 22%" />
<col style="width: 14%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Types of events</p></th>
<th class="head"><p>Log file (relative to /var/log)</p></th>
<th class="head"><p>CloudWatch log group</p></th>
<th class="head"><p>Further details</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Job events</p></td>
<td><p>jenkins/audit-trail.log</p></td>
<td><p>jenkins-access</p></td>
<td><p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/pull/170">PR #170</a></p></td>
</tr>
<tr class="row-odd"><td><p>Web access</p></td>
<td><p>jenkins/access.log</p></td>
<td><p>jenkins-audit</p></td>
<td><p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/pull/171">PR #171</a></p></td>
</tr>
<tr class="row-even"><td><p>SSH access</p></td>
<td><p>auth.log</p></td>
<td><p>server-login-access</p></td>
<td><p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/pull/172">PR #172</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="jenkins-infrastructure">
<h2><a class="toc-backref" href="#id6">Jenkins infrastructure</a><a class="headerlink" href="#jenkins-infrastructure" title="Permalink to this headline">¶</a></h2>
<p>The infrastructure on which Jenkins relies is created in the <code class="docutils literal notranslate"><span class="pre">main</span></code> AWS account.</p>
<p><strong>Shared Infrastructure</strong>: AWS resources created once per account and shared across all Jenkins instances:</p>
<ul class="simple">
<li><p>ELB wildcard certificate</p></li>
<li><p>IAM profile/policy document</p></li>
<li><p>EBS snapshot policy</p></li>
<li><p>S3 bucket to store access logs</p></li>
</ul>
<p>These are defined in the Terraform <code class="docutils literal notranslate"><span class="pre">main</span></code> <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/accounts/main">account</a>.</p>
<p><strong>Per-instance Infrastructure</strong>: AWS resources created once for each jenkins instance. Each Jenkins instance has its own:</p>
<ul class="simple">
<li><p>EC2 instance</p></li>
<li><p>Elastic load balancer (ELB), that uses the shared certificate</p></li>
<li><p>DNS ‘A’ record in Route 53</p></li>
<li><p>Security groups for the EC2 and ELB instances</p></li>
</ul>
<p>These are defined in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/tree/master/terraform/modules/jenkins/jenkins">jenkins.jenkins module</a> and can be instantiated in the <code class="docutils literal notranslate"><span class="pre">main</span></code> account as many times as we
like (typically once). See <a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html#new-jenkins-instance"><span class="std std-ref">Creating a new Jenkins instance</span></a> for details on how to create these resources.</p>
<div class="section" id="shared-infrastructure">
<span id="shared-jenkins-infrastructure"></span><h3><a class="toc-backref" href="#id7">Shared Infrastructure</a><a class="headerlink" href="#shared-infrastructure" title="Permalink to this headline">¶</a></h3>
<div class="section" id="elb-certificate">
<h4><a class="toc-backref" href="#id8">ELB certificate</a><a class="headerlink" href="#elb-certificate" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/accounts/main/route53.tf">Follow along here</a></p>
<p>The <code class="docutils literal notranslate"><span class="pre">route53.tf</span></code> file in the main account defines the certificate used for the Jenkins ELB (see below). The
certificate is a wildcard that covers all subdomains under <code class="docutils literal notranslate"><span class="pre">.marketplace.team.</span></code>. This should make it easier if we have
to replace the current Jenkins instance with a new one. The certificate is validated by a DNS record, which is also
defined here.</p>
</div>
<div class="section" id="roles-and-policies">
<h4><a class="toc-backref" href="#id9">Roles and policies</a><a class="headerlink" href="#roles-and-policies" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/accounts/main/jenkins_instance_profile.tf">Follow along here</a></p>
<p>Jenkins has an <cite>instance profile</cite>. An instance profile is a way of applying a AWS IAM Role (and its associated
permissions) to an AWS EC2 instance. This way, any actions performed by that instance will have the permissions defined.
The permissions that Jenkins has are defined in the <code class="docutils literal notranslate"><span class="pre">jenkins_instance_profile.tf</span></code> file in the main account.</p>
<p>The role the instance profile uses is defined here, as well as a policy document with a bunch of statements in. These
statements define what Jenkins can do, including accessing various S3 buckets, and sending application logs to CloudWatch.
If you’re looking to change Jenkins permissions, this is probably where you want to do it.</p>
<p>Permissions defined on other resources need to know the <code class="docutils literal notranslate"><span class="pre">arn</span></code> (amazon resource name) of the Jenkins instance profile,
so that Jenkins has access. This is why it’s defined here, rather than in the module. A new module can reuse this
instance profile without worrying about breaking permissions elsewhere.</p>
</div>
<div class="section" id="access-log-s3-bucket">
<h4><a class="toc-backref" href="#id10">Access log S3 bucket</a><a class="headerlink" href="#access-log-s3-bucket" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/log_bucket/s3_bucket.tf">Follow along here</a></p>
<p>For audit purposes we want to keep a log of who is accessing the Jenkins server; one way we do this is to configure ELB
to export access logs. These go to an S3 bucket, which is created once in the <code class="docutils literal notranslate"><span class="pre">main</span></code> account using the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/log_bucket/s3_bucket.tf">jenkins.log_bucket</a> terraform sub-module.</p>
</div>
<div class="section" id="ebs-snapshots">
<h4><a class="toc-backref" href="#id11">EBS snapshots</a><a class="headerlink" href="#ebs-snapshots" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/snapshots/snapshots.tf">Follow along here</a></p>
<p>This module defines the snapshot policies for EBS volumes tagged as <code class="docutils literal notranslate"><span class="pre">jenkins</span> <span class="pre">data</span></code> (currently every 24 hrs at 23:30).
Created once in the <code class="docutils literal notranslate"><span class="pre">main</span></code> account using the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/snapshots/s3_bucket.tf">jenkins.snapshots</a> terraform sub-module.</p>
</div>
</div>
<div class="section" id="per-instance-infrastructure">
<h3><a class="toc-backref" href="#id12">Per-instance Infrastructure</a><a class="headerlink" href="#per-instance-infrastructure" title="Permalink to this headline">¶</a></h3>
<div class="section" id="ec2">
<h4><a class="toc-backref" href="#id13">EC2</a><a class="headerlink" href="#ec2" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/jenkins/ec2.tf">Follow along here</a></p>
<p>This is the instance that Jenkins runs on. It’s based on a public image which is currently <code class="docutils literal notranslate"><span class="pre">ami-01e6a0b85de033c99</span></code> which is an
Ubuntu 18.04 LTS image. If you’re particularly interested in ubuntu images, <a class="reference external" href="https://cloud-images.ubuntu.com/locator/">read this list</a>. For more
information on finding an AMI, look at this <a class="reference external" href="https://askubuntu.com/questions/53582/how-do-i-know-what-ubuntu-ami-to-launch-on-ec2">useful post</a></p>
<p>We currently use a <code class="docutils literal notranslate"><span class="pre">t3.large</span></code> instance. As these are charged at a lower ‘reserved’ pricing tier. Agreed with AWS by the Reliability Engineering team.</p>
<p>This section defines an elastic IP address which is associated with the instance. This is important as it allows us to
add this IP to our whitelist for the router. The environment specific whitelists can be found in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials/tree/master/vars">credentials repo in the vars folder</a>.</p>
<p>We also define a key pair to use - the public part is injected into the Terraform as a variable by the Makefile we use
to run our Terraform code. This key lives in our <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials/tree/master/aws-keys">credentials repo under aws-keys</a>.</p>
<p>An extra 100GB volume is defined and attached to the instance. This volume is mounted in the Ansible set up.</p>
<p>The instance is defined with a couple more attributes, specifically an instance profile and a security group, which are
described below.</p>
</div>
<div class="section" id="elb">
<h4><a class="toc-backref" href="#id14">ELB</a><a class="headerlink" href="#elb" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/jenkins/elb.tf">Follow along here</a></p>
<p>Jenkins runs behind an elastic load balancer (ELB). The main reason for this is to take advantage of the free certificate
available from AWS for load balancers.</p>
<p>The ELB listens on port 443 and port 22 and proxies traffic on to the Jenkins instance on port 80 and 22 respectively.
It terminates our https traffic and sends it on as http. Both the ELB and the instance have strict security groups to
protect this traffic, as well as being in the same VPC and subnet.</p>
<p>The ELB performs health checks on the instances that are attached to it (just our Jenkins instance). It does this by
pinging a TCP request to port 22. Usually a health check is performed on port 80, however when standing up a brand new
Jenkins instance with Terraform, there is nothing listening on port 80. If the health check is returned unhealthy twice
in a row then the instance is removed from the ELB. It is <strong>not</strong> destroyed.</p>
<p>To keep an audit trail, we configure the ELB to export access logs every 60 minutes. These are saved to an S3 bucket
(details below).</p>
</div>
<div class="section" id="dns-record-route-53">
<h4><a class="toc-backref" href="#id15">DNS record (Route 53)</a><a class="headerlink" href="#dns-record-route-53" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/jenkins/route53.tf">Follow along here</a></p>
<p>We create an A record for the <code class="docutils literal notranslate"><span class="pre">dns_name</span></code> variable passed in to the module. This will be something like
<code class="docutils literal notranslate"><span class="pre">ci.marketplace.team</span></code>, but can actually use any subdomain due to our use of a wildcard certificate. Usually an A
record would point directly to an IP address, however AWS allows you to define an alias to a load balancer. This is
convenient as the DNS of a load balancer is long and horrible and not guaranteed to remain consistent. The code here
will automatically grab the details required for this alias from the load balancer created elsewhere in the module.</p>
</div>
<div class="section" id="security-groups">
<h4><a class="toc-backref" href="#id16">Security Groups</a><a class="headerlink" href="#security-groups" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/terraform/modules/jenkins/jenkins/security_group.tf">Follow along here</a></p>
<p>This is where we define who can access the ELB and the EC2 instance. Two security groups are defined, one for each of
the ELB and EC2, with different ingress (who can talk to the box) and egress (who the box can talk to).</p>
<p>The ELB security group allows TCP access to port 22 only for IP address in our list of developer IPs. These can be found
in <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials/blob/master/terraform/common.json">digitalmarketplace-credentials/terraform/common.json</a>.
Any traffic received on port 22 from a whitelisted IP is proxied directly to port 22 on the EC2 instance. Rather than
defining the location of the EC2 instance with a CIDR block, we just define the source security group (the security
group of the EC2 instance).</p>
<p>The ELB security group allows HTTPS access on port 443 to the list of developer IPs <em>as well as</em> the elastic IP used by
the EC2 instance. This is important, as some of the Ansible code requires an HTTP request be made to itself. HTTPS
traffic is terminated here and proxied on to port 80 in the EC2 instance via HTTP. Both the ELB and EC2 are in our
private AWS VPC and on the same subnet within that, so the unsecured traffic never leaves our own network.</p>
<p>The EC2 security group works in a similar way to the ELB security group, except ingress is restricted to ports 80 and 22
and only to traffic coming from the ELB (by defining the source security group as the ELB’s security group). Egress for
the instance is unrestricted.</p>
<img alt="../_images/jenkins-security-group-setup.png" src="../_images/jenkins-security-group-setup.png" />
<p>(The <a class="reference external" href="https://drive.google.com/open?id=1F7zJK_i0rwacmIgzuIPtsuyda8KljKdh">security group diagram source</a> can be opened using <code class="docutils literal notranslate"><span class="pre">draw.io</span></code> in Google Drive if it needs to be edited.)</p>
</div>
</div>
<div class="section" id="installing-jenkins-itself">
<h3><a class="toc-backref" href="#id17">Installing Jenkins itself</a><a class="headerlink" href="#installing-jenkins-itself" title="Permalink to this headline">¶</a></h3>
<p>Jenkins itself is configured using <a class="reference external" href="https://www.ansible.com/overview/how-ansible-works">Ansible</a>, while the jobs within Jenkins use <a class="reference external" href="https://jenkins-job-builder.readthedocs.io/en/latest/index.html">Jenkins Job Builder</a>.</p>
<p>Once the infrastructure steps above have completed, run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> from the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins">digitalmarketplace-jenkins repo</a> to install and configure Jenkins and Jenkins Job Builder.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is possible to manually edit config and jobs in the Jenkins web UI, however any config changes that deviate
from what Jenkins Job Builder maintains will be lost whenever Jenkins restarts. Make sure any changes are committed to
the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins">digitalmarketplace-jenkins repo</a> and applied using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">reconfigure</span></code> or <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">jobs</span></code>.
This includes enabling/disabling jobs as well as editing what the jobs actually do.</p>
</div>
<p>We also use various Jenkins plugins (such as the pipeline workflow). More details about these can be found in the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/README.md">digitalmarketplace-jenkins repo README</a>.</p>
</div>
<div class="section" id="destroying-jenkins">
<h3><a class="toc-backref" href="#id18">Destroying Jenkins</a><a class="headerlink" href="#destroying-jenkins" title="Permalink to this headline">¶</a></h3>
<p>The terraform module for Jenkins enables instance termination protection to
make it harder to accidentally delete the root volume for the Jenkins instance.
Terminating the instance is not possible from the AWS console or cli. If you
want to terminate the Jenkins instance you can either remove it from the
terraform, or follow the instructions on AWS on how to <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/terminating-instances.html#Using_ChangingDisableAPITermination">change termination protection</a>.</p>
</div>
<div class="section" id="rebuilding-jenkins-from-scratch">
<h3><a class="toc-backref" href="#id19">Rebuilding Jenkins from scratch</a><a class="headerlink" href="#rebuilding-jenkins-from-scratch" title="Permalink to this headline">¶</a></h3>
<p>If the worst happens, or we just fancy it, and we need to completely recreate Jenkins please see
<a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html#rebuilding-jenkins"><span class="std std-ref">here for a rough guide.</span></a></p>
</div>
</div>
<div class="section" id="how-jenkins-uses-credentials">
<h2><a class="toc-backref" href="#id20">How Jenkins uses credentials</a><a class="headerlink" href="#how-jenkins-uses-credentials" title="Permalink to this headline">¶</a></h2>
<p>As a CI/CD server, Jenkins needs access to many of our credentials in order to run jobs that automate our build and
deployment processes, as well as to run other jobs as part of maintaining the Digital Marketplace. These credentials
are exposed to our jobs in some different ways, though our plan going forward is primarily to pass any secrets
through environment variables.</p>
<div class="section" id="jenkins-global-configuration">
<h3><a class="toc-backref" href="#id21">Jenkins global configuration</a><a class="headerlink" href="#jenkins-global-configuration" title="Permalink to this headline">¶</a></h3>
<p>A number of our Jenkins jobs expect to be given certain environment variables containing the credentials they need.
Generally, where this is the case, these are sourced from Jenkins global configuration (Manage Jenkins -&gt; Configure
System -&gt; Global properties). Here we define a number of tokens (primarily for the Data and Search APIs across all
environments, and for Notify/Mailchimp). These tokens are statically defined in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials repo</a> in
<code class="docutils literal notranslate"><span class="pre">jenkins-vars/jenkins.yaml</span></code> and are updated when Jenkins config is applied (with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">reconfigure</span></code> from the
digitalmarketplace-jenkins repository).</p>
<p>If these tokens are not in sync with what the apps in those stages are expecting, a number of our jobs will fail due to
be unable to authenticate with eg the APIs.</p>
<dl class="simple">
<dt>Some examples of jobs that read from Jenkins global configuration:</dt><dd><ul class="simple">
<li><p>stats_snapshots</p></li>
<li><p>notify_suppliers_of_new_questions_answers</p></li>
<li><p>smoke_tests</p></li>
<li><p>functional_tests</p></li>
<li><p>index_briefs</p></li>
<li><p>index_services</p></li>
</ul>
</dd>
</dl>
<p>The environment variables for Jenkins itself are defined in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-jenkins/blob/main/playbooks/roles/jenkins/templates/jenkins_defaults.j2">jenkins_defaults.j2 Ansible template</a>. These
include the <code class="docutils literal notranslate"><span class="pre">JAVA_ARGS</span></code> provided to <code class="docutils literal notranslate"><span class="pre">/etc/default/jenkins</span></code>, such as Content Security Policy.</p>
</div>
<div class="section" id="decrypting-dm-credentials">
<h3><a class="toc-backref" href="#id22">Decrypting dm-credentials</a><a class="headerlink" href="#decrypting-dm-credentials" title="Permalink to this headline">¶</a></h3>
<p>Other Jenkins jobs use a local checkout of the dm-credentials repository maintained on the Jenkins host. A separate job,
<code class="docutils literal notranslate"><span class="pre">update-credentials</span></code>, pulls the latest master branch of the repository to make sure it’s updated as needed. Most of the jobs that
use this method are those which interact with CloudFoundry to deploy/manage our applications and services.</p>
<dl class="simple">
<dt>Some examples of jobs that decrypt dm-credentials on demand:</dt><dd><ul class="simple">
<li><p>clean_and_apply_db_dump</p></li>
<li><p>database_migration_paas</p></li>
<li><p>release_application_paas</p></li>
<li><p>build_image</p></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="jenkins-chores">
<h2><a class="toc-backref" href="#id23">Jenkins chores</a><a class="headerlink" href="#jenkins-chores" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html#upgrading-jenkins"><span class="std std-ref">Upgrading jenkins</span></a></p></li>
<li><p><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html#rebuilding-jenkins"><span class="std std-ref">Rebuilding Jenkins from scratch</span></a></p></li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="github-actions.html" class="btn btn-neutral float-right" title="GitHub Actions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="elasticsearch.html" class="btn btn-neutral float-left" title="Elasticsearch" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>