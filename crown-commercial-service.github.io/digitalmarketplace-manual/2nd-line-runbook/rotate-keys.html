

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Rotating API keys &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Debugging PaaS App Instances" href="debugging-paas-app-instances.html" />
    <link rel="prev" title="Rebuilding Jenkins from scratch" href="rebuilding-jenkins.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/nix.html">Nix Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/moving-data.html">Moving data between environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing-the-digital-marketplace/production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/aws-resources.html">AWS Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/code-backups.html">Code backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/database-backups.html">Database backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/emails.html">Email integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/jenkins.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Rotating API keys</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#rotating-data-api-and-search-api-keys">Rotating Data API and Search API keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rotating-jenkins-docker-credentials">Rotating Jenkins Docker credentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rotating-notify-api-keys">Rotating Notify API keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rotating-aws-access-keys">Rotating AWS Access keys</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Rotating API keys</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/2nd-line-runbook/rotate-keys.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rotating-api-keys">
<span id="rotate-keys"></span><h1><a class="toc-backref" href="#id1">Rotating API keys</a><a class="headerlink" href="#rotating-api-keys" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#rotating-api-keys" id="id1">Rotating API keys</a></p>
<ul>
<li><p><a class="reference internal" href="#rotating-data-api-and-search-api-keys" id="id2">Rotating Data API and Search API keys</a></p></li>
<li><p><a class="reference internal" href="#rotating-jenkins-docker-credentials" id="id3">Rotating Jenkins Docker credentials</a></p></li>
<li><p><a class="reference internal" href="#rotating-notify-api-keys" id="id4">Rotating Notify API keys</a></p></li>
<li><p><a class="reference internal" href="#rotating-aws-access-keys" id="id5">Rotating AWS Access keys</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="rotating-data-api-and-search-api-keys">
<h2><a class="toc-backref" href="#id2">Rotating Data API and Search API keys</a><a class="headerlink" href="#rotating-data-api-and-search-api-keys" title="Permalink to this headline">¶</a></h2>
<p>API keys for the Data API, Search API and Antivirus API are stored in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials</a> repository.
Our applications (both API and frontend), other Digital Marketplace components (eg scripts), and developers use these
keys to talk to the APIs.</p>
<p><code class="docutils literal notranslate"><span class="pre">digitalmarketplace-credentials/vars/preview.yaml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="p">:</span>
    <span class="n">auth_tokens</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">A</span><span class="o">-</span><span class="n">first</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="ow">is</span><span class="o">-</span><span class="n">used</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">other</span><span class="o">-</span><span class="n">applications</span>
    <span class="o">-</span> <span class="n">J</span><span class="o">-</span><span class="n">second</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="ow">is</span><span class="o">-</span><span class="n">used</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">jenkins</span>
    <span class="o">-</span> <span class="n">D</span><span class="o">-</span><span class="n">third</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="ow">is</span><span class="o">-</span><span class="n">be</span><span class="o">-</span><span class="n">used</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">developers</span>
</pre></div>
</div>
<p>In the event that a key is leaked then it should be rotated. If a developer leaves the Digital Marketplace, then
production tokens (at least) should be rotated. A Jenkins job called <code class="docutils literal notranslate"><span class="pre">Rotate</span> <span class="pre">API</span> <span class="pre">tokens</span></code> exists to generate new tokens
and push them out to our applications, following the correct process for a seamless transition. We have three tokens
for each API:</p>
<ul class="simple">
<li><p>An application token that starts with ‘A’</p></li>
<li><p>A Jenkins token that starts with ‘J’</p></li>
<li><p>A developer token that starts with ‘D’</p></li>
</ul>
<p>The Jenkins job is a Pipeline that has five main stages:</p>
<ol class="arabic simple">
<li><p>The pipeline will generate a new Pull Request against the credentials repository to add three new tokens each for
the Data API and Search API. A developer will need to manually merge this.</p></li>
<li><p>Go back to the pipeline and proceed through the next two dialogue boxes to deploy the Search API, then deploy the
Data API, and then deploy all other apps simultaneously.</p></li>
<li><p>After all of the apps have released and the pipeline is paused at the ‘Update Jenkins config’ stage, a developer
needs to update Jenkins config. To do this, prepare Jenkins for shutdown (Manage Jenkins -&gt; Prepare for Shutdown) to
stop any new jobs from being started. Wait for existing jobs to finish running and notify developers on #dm-2ndline
that Jenkins will be restarted shortly, then run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">reconfigure</span></code> from the <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-jenkins</span></code>
repository to push the updated tokens for Jenkins to inject into the environment for scripts/etc. You must have
DM_CREDENTIALS_REPO defined and it must point at a version of <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-credentials</span></code> that contains the
newly-added tokens. After Jenkins has restarted, continue the Pipeline by clicking ‘Proceed’ twice.</p></li>
<li><p>Pipeline stage 4 will generate another Pull Request against the <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-credentials</span></code> repository to
remove the old tokens from the Data API and the Search API. A developer will need to manually merge this.</p></li>
<li><p>Finally, continue the pipeline again by clicking ‘proceed’ twice to deploy the Search API, then the Data API, then
all other apps (apps don’t access the Antivirus API directly, so it’s unimportant when the Antivirus API is
restarted).</p></li>
</ol>
</div>
<div class="section" id="rotating-jenkins-docker-credentials">
<h2><a class="toc-backref" href="#id3">Rotating Jenkins Docker credentials</a><a class="headerlink" href="#rotating-jenkins-docker-credentials" title="Permalink to this headline">¶</a></h2>
<p>Jenkins has its own <a class="reference external" href="https://hub.docker.com">Docker Hub</a> account which it uses to publish Docker images that it builds. This account is
protected by two-factor authentication, and is accessed by Jenkins using a Docker Hub <a class="reference external" href="https://docs.docker.com/docker-hub/access-tokens/">personal access token</a>.</p>
<p>The account token is kept in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials</a> repo, in the file
<code class="docutils literal notranslate"><span class="pre">jenkins-vars/docker_credentials_env.enc</span></code>, as an environment variable called <code class="docutils literal notranslate"><span class="pre">DOCKER_PASSWORD</span></code>.</p>
<p>This is a manual process during which releases/merges should be paused.</p>
<ol class="arabic simple">
<li><p>Post a message in the <a class="reference external" href="https://slack.com/app_redirect?channel=dm-2ndline">#dm-2ndline</a> Slack channel warning the team not to merge or release.</p></li>
<li><p>Using the details for the Jenkins user in the credentials file <code class="docutils literal notranslate"><span class="pre">pass/docker.com/jenkins-ci</span></code>, log in to the
Docker Hub console. To do this you will need to reset the password (generate a new one with your choice of reputable
token generator).</p></li>
<li><p>Create a new access token <a class="reference external" href="https://docs.docker.com/docker-hub/access-tokens/">following the instructions in the Docker manual</a>. Make sure to
give the token a memorable name, like “jenkins (new)”. Copy the token into the credentials file
<code class="docutils literal notranslate"><span class="pre">jenkins-vars/docker_credentials_env.enc</span></code>.</p></li>
<li><p>Delete the old access token and rename the new access token (which should now be the only access token) to “jenkins”.</p></li>
<li><p>Log out of Docker Hub, and throw the account password away.</p></li>
<li><p>Commit the new token to <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials</a> and open a pull request. Get the PR reviewed and merged.</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">update-credentials</span></code> job in the Jenkins console.</p></li>
<li><p>SSH into Jenkins and delete the <code class="docutils literal notranslate"><span class="pre">/var/lib/jenkins/.docker</span></code> folder to remove the auth token.</p></li>
<li><p>Still in the Jenkins box, log in with the new token: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-u</span> <span class="pre">jenkins</span> <span class="pre">docker</span> <span class="pre">login</span></code></p></li>
<li><p>Test with a Docker image job (e.g. run the <a class="reference external" href="https://ci.marketplace.team/job/docker-base-images/">Refresh Docker base images</a> job).</p></li>
<li><p>Give the all clear in the <a class="reference external" href="https://slack.com/app_redirect?channel=dm-2ndline">#dm-2ndline</a> Slack channel.</p></li>
</ol>
</div>
<div class="section" id="rotating-notify-api-keys">
<h2><a class="toc-backref" href="#id4">Rotating Notify API keys</a><a class="headerlink" href="#rotating-notify-api-keys" title="Permalink to this headline">¶</a></h2>
<p>We should normally only have two “Live” Notify API keys at a time: one for the (production) applications and one for
Jenkins. These are the only ones it’s particularly useful to rotate: “Test” and “Team and Whitelist” tokens are
relatively powerless.</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Create two new “Live” Notify API keys using the Notify dashboard.</dt><dd><ul class="simple">
<li><p>One named in the format <code class="docutils literal notranslate"><span class="pre">APPLICATION-PRODUCTION-&lt;date&gt;</span></code>. Use this key to replace the <code class="docutils literal notranslate"><span class="pre">notify_api_key</span></code>
variable in the <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials</a> repo’s <code class="docutils literal notranslate"><span class="pre">vars/production.yaml</span></code> file.</p></li>
<li><p>One named in the format <code class="docutils literal notranslate"><span class="pre">JENKINS-LIVE-&lt;date&gt;</span></code>. Use this key to replace the
<code class="docutils literal notranslate"><span class="pre">jenkins_env_variables.NOTIFY_API_TOKEN</span></code> <strong>and</strong>
<code class="docutils literal notranslate"><span class="pre">jenkins_env_variables.NOTIFY_API_FUNCTIONAL_TESTS_KEY_PRODUCTION</span></code> variables in the
<a class="reference external" href="https://github.com/alphagov/digitalmarketplace-credentials">digitalmarketplace-credentials</a> repo’s <code class="docutils literal notranslate"><span class="pre">jenkins-vars/jenkins.yaml</span></code> file.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Commit these changes and get the resulting PR approved and merged.</p></li>
<li><p><em>Ensuring you have this latest credentials revision checked out in your local credentials repository</em>, prepare
Jenkins for shutdown (<a class="reference external" href="https://ci.marketplace.team/manage">Manage Jenkins &gt; Prepare for Shutdown</a>), Wait for existing jobs to finish running and notify
developers on <code class="docutils literal notranslate"><span class="pre">#dm-2ndline</span></code> that Jenkins will be restarted shortly, then run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">reconfigure</span></code> from the
<code class="docutils literal notranslate"><span class="pre">digitalmarketplace-jenkins</span></code> repository.</p></li>
<li><p>Run the “Re-release all apps” jenkins job against <code class="docutils literal notranslate"><span class="pre">production</span></code> to ensure all the apps have picked up the new
notify key.</p></li>
<li><p>It’s probably best to take a look at the “Message log” in the Notify dashboard (under “API integration”) and check
you can see the new keys in use (and that you <em>can’t</em> see the old keys still being in use).</p></li>
<li><p>Delete the old keys in the Notify dashboard.</p></li>
</ol>
</div>
<div class="section" id="rotating-aws-access-keys">
<h2><a class="toc-backref" href="#id5">Rotating AWS Access keys</a><a class="headerlink" href="#rotating-aws-access-keys" title="Permalink to this headline">¶</a></h2>
<p>The apps hosted on PaaS use an AWS Access Key to connect with S3 buckets and other AWS resources. There is an
access key for each AWS account (development and production).</p>
<p>To rotate an access key, do the following steps for each account:</p>
<ol class="arabic simple">
<li><p>In the AWS console, <a class="reference internal" href="../infrastructure/aws-accounts.html#switching-roles"><span class="std std-ref">switch role</span></a> (to either <code class="docutils literal notranslate"><span class="pre">infrastructure</span></code> or <code class="docutils literal notranslate"><span class="pre">admin</span></code> role) for the
relevant account.</p></li>
<li><p>Create new key for the <code class="docutils literal notranslate"><span class="pre">paas-app</span></code> user for that account in AWS console:
IAM &gt; Users &gt; <code class="docutils literal notranslate"><span class="pre">paas-app</span></code> &gt; Security Credentials &gt; Access Keys
Each user can have a max of 2 keys.</p></li>
<li><p>Add the new <code class="docutils literal notranslate"><span class="pre">aws_access_key_id</span></code> and <code class="docutils literal notranslate"><span class="pre">aws_secret_access_key</span></code> to the credentials repo in <code class="docutils literal notranslate"><span class="pre">vars/&lt;stage&gt;.yml</span></code>.
Commit, review and merge the PR.</p></li>
<li><p><a class="reference external" href="https://ci.marketplace.team/job/rerelease-all-apps/">Re-release all apps via Jenkins</a> to inject the new <code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code> and
<code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code> environment vars into the PaaS apps.</p></li>
<li><p>Try accessing a <strong>restricted</strong> document on Digital Marketplace for the relevant stage(s). For example, log in as a
supplier and download/upload a service document.</p></li>
<li><p>In the AWS console, check that the new key has been used (and that the old key has not been used since the release).
This information may take up to 5 minutes to appear in the AWS console. If it doesn’t appear, check if logs for the
stage are appearing in CloudWatch (the PaaS apps use the AWS access key to send logs to CloudWatch). If there
are no logs in CloudWatch, the key is probably invalid/misconfigured and you will need to start again.</p></li>
<li><p>Once you’re confident the new key is being used, make the old key inactive in the AWS console (this is reversible and
it doesn’t need to be deleted straight away).</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="debugging-paas-app-instances.html" class="btn btn-neutral float-right" title="Debugging PaaS App Instances" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rebuilding-jenkins.html" class="btn btn-neutral float-left" title="Rebuilding Jenkins from scratch" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>