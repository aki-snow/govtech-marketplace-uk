

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Moving data between environments &mdash; digitalmarketplace-manual 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="URLs" href="urls.html" />
    <link rel="prev" title="Migrating the Digital Marketplace frontend" href="frontend-migration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> digitalmarketplace-manual
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Digital Marketplace background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/deportalising.html">History: From G-Cloud 5 to G-Cloud 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/finding-things.html">Finding Things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/journeys.html">User Journeys on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digital-marketplace-background/gdpr.html">GDPR</a></li>
</ul>
<p class="caption"><span class="caption-text">Developing the Digital Marketplace</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="accessing-the-api.html">Accessing the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding-repos.html">Adding a new repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="application-architecture.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="browser-support.html">Browser and accessibility support</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer-setup.html">Developer setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="decision-records.html">Recording decisions on the Digital Marketplace</a></li>
<li class="toctree-l1"><a class="reference internal" href="digitalmarketplace-runner.html">Digital Marketplace Runner (‘dmrunner’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="nix.html">Nix Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="development-and-deployment-process.html">Development and deployment process</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontend-migration.html">Migrating the Digital Marketplace frontend</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Moving data between environments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#moving-data-from-production-to-preview-or-staging">Moving data from production to preview or staging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-do-it">How do I do it?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-is-actually-happening">What is actually happening?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#importing-data-for-developers">Importing data for developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="urls.html">URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="users.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="google-analytics.html">Google Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="load-testing.html">Load testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="automated-testing.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="splitting-applications.html">Splitting or adding a frontend application</a></li>
<li class="toctree-l1"><a class="reference internal" href="database-migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker-strategies.html">Docker strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontend-assets-and-tools.html">Frontend assets and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-typing-strategy.html">Python typing strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="production-guidelines.html">Guidelines for accessing production data and systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Content and frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-frameworks.html">Preparing to add a new framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-lifecycle-for-developers.html">Framework lifecycle for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/how-suppliers-apply-to-a-framework.html">How suppliers apply to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/framework-agreements.html">Framework agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/contract-variations.html">Contract variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/adding-a-new-form-field-type.html">Adding a new form field type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/finding-content.html">Finding content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/changing-content.html">Changing content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-and-frameworks/useful-api-endpoints-for-frameworks.html">Useful API endpoints for frameworks</a></li>
</ul>
<p class="caption"><span class="caption-text">Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/antivirus.html">The Antivirus API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/aws-accounts.html">AWS accounts and access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/aws-resources.html">AWS Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/code-backups.html">Code backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/database-backups.html">Database backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/domains.html">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/emails.html">Email integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/jenkins.html">Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/github-actions.html">GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/logging.html">Logging, monitoring and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/maintenance-mode.html">Maintenance Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/python-environments.html">Python environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/paas.html">What is PaaS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/paas.html#deploying-digital-marketplace-apps-to-gov-uk-paas">Deploying Digital Marketplace apps to GOV.UK PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/rate-limiting.html">Rate Limiting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/upgrading-backend-services.html">Upgrading backend services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/session-management.html">Session Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing People and Secret Things</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/credentials.html">Credentials and secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/accounts.html">Adding and removing access for new starters / leavers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../managing-people-and-secret-things/production-access.html">Requirements for access to production environments</a></li>
</ul>
<p class="caption"><span class="caption-text">2nd Line Runbook</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/incidents.html">Incidents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html">Logging in to databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/logging-in-to-paas-databases.html#resetting-brief-data-with-conduit">Resetting brief data with conduit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/blocking-ips.html">IP Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/upgrading-jenkins.html">Upgrading Jenkins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rebuilding-jenkins.html">Rebuilding Jenkins from scratch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/rotate-keys.html">Rotating API keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/debugging-paas-app-instances.html">Debugging PaaS App Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/vulnerability-scanning.html">Vulnerability scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/novations.html">Novations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/support-tasks.html">Support Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/investigating-alerts.html">Responding to Cloudwatch alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2nd-line-runbook/buyer-domain-allow-list.html">Buyer Domain Allow List</a></li>
</ul>
<p class="caption"><span class="caption-text">What is this?</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alphagov/digitalmarketplace-manual/blob/master/README.md">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">digitalmarketplace-manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Moving data between environments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Crown-Commercial-Service/digitalmarketplace-manual/blob/main/manual/developing-the-digital-marketplace/moving-data.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="moving-data-between-environments">
<span id="moving-data"></span><h1><a class="toc-backref" href="#id1">Moving data between environments</a><a class="headerlink" href="#moving-data-between-environments" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#moving-data-between-environments" id="id1">Moving data between environments</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#moving-data-from-production-to-preview-or-staging" id="id3">Moving data from production to preview or staging</a></p>
<ul>
<li><p><a class="reference internal" href="#how-do-i-do-it" id="id4">How do I do it?</a></p></li>
<li><p><a class="reference internal" href="#what-is-actually-happening" id="id5">What is actually happening?</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#importing-data-for-developers" id="id6">Importing data for developers</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id2">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Moving data, whether to other environments or to development machines, has traditionally been a problem for us. It is no longer a technical problem.</p>
<p>The Jenkins job which moves the data is scheduled to automatically run against staging every week on a Sunday. This way we always keep staging data close to production. The job can also be run manually against preview or staging, or just to create a clean dump shared on S3.</p>
<p><a class="reference external" href="https://ci.marketplace.team/view/Data">Check it out</a>.</p>
</div>
<div class="section" id="moving-data-from-production-to-preview-or-staging">
<h2><a class="toc-backref" href="#id3">Moving data from production to preview or staging</a><a class="headerlink" href="#moving-data-from-production-to-preview-or-staging" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-do-i-do-it">
<h3><a class="toc-backref" href="#id4">How do I do it?</a><a class="headerlink" href="#how-do-i-do-it" title="Permalink to this headline">¶</a></h3>
<p>Moving data is easy as.</p>
<ul class="simple">
<li><p>Visit our <a class="reference external" href="https://ci.marketplace.team/view/Data">continuous integration server</a></p></li>
<li><p>Pick a <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> (i.e. the database or S3 bucket to fill with new data)</p>
<ul>
<li><p>Valid targets are <code class="docutils literal notranslate"><span class="pre">preview</span></code>, <code class="docutils literal notranslate"><span class="pre">staging</span></code>, <code class="docutils literal notranslate"><span class="pre">s3</span></code></p></li>
</ul>
</li>
<li><p>Find the “Clean and apply database dump - TARGET” job</p></li>
<li><p>Click “Build Now”</p></li>
<li><p>Wait for like 25 minutes</p>
<ul>
<li><p>(Buy more <a class="reference external" href="http://www.nicecupofteaandasitdown.com/biscuits/previous.php3?item=5">biscuits</a> if there are none left)</p></li>
</ul>
</li>
<li><p>You should now see a sanitized version of production on the target stage and a new dump in the S3 bucket.</p></li>
</ul>
</div>
<div class="section" id="what-is-actually-happening">
<h3><a class="toc-backref" href="#id5">What is actually happening?</a><a class="headerlink" href="#what-is-actually-happening" title="Permalink to this headline">¶</a></h3>
<p>It’s a bit of a fafflafel, but here’s the basic algorithm what happens whenever you click “Build” (as seen above).</p>
<ul class="simple">
<li><p>The status page for the target stage (if <a class="reference external" href="https://www.preview.marketplace.team/_status">preview</a> or <a class="reference external" href="https://www.staging.marketplace.team/_status">staging</a>) is requested and the api’s current alembic version stored for use later.</p></li>
<li><p>A new Docker container is run on Jenkins from a Postgres base image. This is where we cleanup the production data.</p></li>
<li><p>Jenkins checks our database-backups S3 bucket for the latest production database dump (a new one is created every morning) and downloads it.</p></li>
<li><p>The dump is then decrypted with GPG using the private key in the credentials repo, unzipped, and then imported into the Docker container.</p></li>
<li><p>The database in the container is then <a class="reference external" href="https://github.com/alphagov/digitalmarketplace-aws/blob/master/scripts/clean-db-dump.sql">cleaned</a> using a series of SQL queries that purge personal and confidential data.
This step also <em>generates</em> an amount of pseudorandomly varied data to replace some of the removed data in order to
provide test environments with a more realistic, diverse dataset.</p></li>
<li><p>The cleaned database is then queried for its alembic version. This is stored for later.</p></li>
<li><p>Jenkins then uses <code class="docutils literal notranslate"><span class="pre">pg_dump</span></code> to create a dump of this cleaned database, zips it, and then saves it to disk.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> is <code class="docutils literal notranslate"><span class="pre">s3</span></code> then the script skips all the following steps up until the point where it uploads to S3.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> is <code class="docutils literal notranslate"><span class="pre">preview</span></code> or <code class="docutils literal notranslate"><span class="pre">staging</span></code> then Jenkins targets the appropriate Cloud Foundry space, fetches the credentials for the postgres service containing that stages database, creates an ssh tunnel to it and applies the cleaned dump to it with <code class="docutils literal notranslate"><span class="pre">psql</span></code>. The dumps are created with the <code class="docutils literal notranslate"><span class="pre">--clean</span></code> flag so they will drop any database objects before replacing them. The cleaned dump is synced with S3 in the same way as mentioned above and is then deleted from Jenkins.</p></li>
<li><p>There is a chance that the target stage may have more advanced migrations than production. Jenkins compares the alembic versions stored in previous steps, and if they do not match will run the <a class="reference external" href="https://ci.marketplace.team/job/database-migration-paas/">database-migration-paas</a> job against the target stage.</p></li>
<li><p>Next, as there is new data in the target stages database, the services and briefs need to be indexed. Jenkins uses the existing <code class="docutils literal notranslate"><span class="pre">index-&lt;briefs</span> <span class="pre">|</span> <span class="pre">services&gt;-&lt;preview</span> <span class="pre">|</span> <span class="pre">staging&gt;</span></code> jobs for this.</p></li>
<li><p>Because new indexes have been created, the aliases being used needs to be shifted. Currently we only have one alias per framework type, i.e. <code class="docutils literal notranslate"><span class="pre">g-cloud</span></code> and <code class="docutils literal notranslate"><span class="pre">briefs-digital-outcomes-and-specialists</span></code>. Jenkins uses the <code class="docutils literal notranslate"><span class="pre">update-&lt;preview</span> <span class="pre">|</span> <span class="pre">staging&gt;-index-alias</span></code> job to move it to the new index.</p></li>
<li><p>Jenkins then syncs the zipped dump with an S3 bucket in the digitalmarketplace-development account, deletes its local dump, and we’re pretty much done. The sync process removes any old files so the directory doesn’t become massive.</p></li>
<li><p>The final step is to clean up. The Docker container and its volume are destroyed, and Jenkins logs out from Cloud Foundry</p></li>
</ul>
<p>After all of this is complete, we should have filled one of our non-production databases with cleaned data and saved the dump in a shared place where other developers can acess it. Pretty rad.</p>
</div>
</div>
<div class="section" id="importing-data-for-developers">
<span id="importing-data-developers"></span><h2><a class="toc-backref" href="#id6">Importing data for developers</a><a class="headerlink" href="#importing-data-for-developers" title="Permalink to this headline">¶</a></h2>
<p>So it’s all well and good wiping out everything in the preview setup, but what about when we want to blow up everything in our own databases? How do we do that?</p>
<p>Luckily, this need has been anticipated and it’s actually fairly simple. If you’re using dmrunner, run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">data</span></code>. Otherwise, you’ll need to:</p>
<ul class="simple">
<li><p>visit <a class="reference external" href="https://s3.console.aws.amazon.com/s3/buckets/digitalmarketplace-cleaned-db-dumps">the “digitalmarketplace-cleaned-db-dumps” bucket</a> in S3.</p></li>
<li><p>Download <code class="docutils literal notranslate"><span class="pre">cleaned-&lt;stage&gt;-&lt;date&gt;.sql.gz</span></code></p>
<ul>
<li><p>this was created the last time data was moved, so if you want a more up to date version run the “<a class="reference external" href="https://ci.marketplace.team/job/clean-and-apply-db-dump-s3">Clean and apply database dump</a>” job with the <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> as <code class="docutils literal notranslate"><span class="pre">s3</span></code>.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">gzcat</span> <span class="pre">./cleaned-&lt;stage&gt;-&lt;date&gt;.sql.gz</span> <span class="pre">|</span> <span class="pre">psql</span> <span class="pre">-f</span> <span class="pre">-</span> <span class="pre">digitalmarketplace</span></code> (adjust for the target database name and
specific path of the downloaded file)</p></li>
<li><p>You may need to run migrations locally. From your local api repo run <cite>make run-migrations</cite> if you do.</p></li>
<li><p>Reindex the new data so it appears in search results using <code class="docutils literal notranslate"><span class="pre">digitalmarketplace-scripts/scripts/index-to-search-service.py</span></code>.</p></li>
<li><p>Boom. Done.</p>
<ul>
<li><p>Have one of those biscuits you bought earlier.</p></li>
</ul>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="urls.html" class="btn btn-neutral float-right" title="URLs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="frontend-migration.html" class="btn btn-neutral float-left" title="Migrating the Digital Marketplace frontend" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013 - 2021 Digital Marketplace

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>